
-- This List Maybe Old so you can query the database to get the latest
-- Query to get all current functions list
Select 
--ROW_NUMBER() OVER (ORDER BY Name) AS row_num,
chr(10)
||'--==================================================='||chr(10)
||'-- Object Type : '||Upper(type)||chr(10)
||'-- Object Name : '||Upper(name)||chr(10)
||'-- Object Description : '||description||chr(10)
||'-- Object ID : '||id||chr(10)
||'--==================================================='||chr(10)
||' Object Source Code IS : '||chr(10)
||'--==================================================='||chr(10)||Source_Code 
||chr(10)||'--==================================================='||chr(10)
as Database_Objects_Info
, CHR(10)||'****** End Of Object Info ****** [ '|| Upper(name)||' ] '||CHR(10)||'--====================================='||chr(10)n
From(
SELECT 
        CASE p.prokind
        WHEN 'f' THEN 'function'
        WHEN 'p' THEN 'procedure'
        WHEN 'a' THEN 'aggregate'
        WHEN 'w' THEN 'window function'
    END AS type,
    p.oid id,
p.proname as Name ,
        COALESCE(d.description, '') AS description,
        pg_get_functiondef(p.oid) as Source_Code
        
    FROM pg_proc p
    JOIN pg_namespace n ON n.oid = p.pronamespace
    LEFT JOIN pg_description d ON d.objoid = p.oid
    WHERE n.nspname = 'public'
)
;


| database_objects_info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | n                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : IS_ADMIN
-- Object Description : Check if current user has admin role in active tenant
-- Object ID : 18613
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM org_users_mst
    WHERE user_id = auth.uid()
      AND tenant_org_id = current_tenant_id()
      AND role = 'admin'
      AND is_active = true
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ IS_ADMIN ] 
--=====================================
                                           |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : IS_OPERATOR
-- Object Description : Check if current user has operator or admin role
-- Object ID : 18614
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.is_operator()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM org_users_mst
    WHERE user_id = auth.uid()
      AND tenant_org_id = current_tenant_id()
      AND role IN ('admin', 'operator')
      AND is_active = true
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ IS_OPERATOR ] 
--=====================================
                                        |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_TENANT_ACCESS
-- Object Description : Check if user has access to specified tenant
-- Object ID : 18615
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_tenant_access(p_tenant_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM org_users_mst
    WHERE user_id = auth.uid()
      AND tenant_org_id = p_tenant_id
      AND is_active = true
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 
****** End Of Object Info ****** [ HAS_TENANT_ACCESS ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_USER_TENANTS
-- Object Description : Get all tenants accessible by current authenticated user
-- Object ID : 18626
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_user_tenants()
 RETURNS TABLE(tenant_id uuid, tenant_name character varying, tenant_slug character varying, user_role character varying, is_active boolean, last_login_at timestamp without time zone)
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    t.id AS tenant_id,
    t.name AS tenant_name,
    t.slug AS tenant_slug,
    u.role AS user_role,
    u.is_active AS is_active,
    u.last_login_at AS last_login_at
  FROM org_users_mst u
  INNER JOIN org_tenants_mst t ON u.tenant_org_id = t.id
  WHERE u.user_id = auth.uid()
    AND u.is_active = true
    AND t.is_active = true
  ORDER BY u.last_login_at DESC NULLS LAST;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
****** End Of Object Info ****** [ GET_USER_TENANTS ] 
--=====================================
                                   |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : SWITCH_TENANT_CONTEXT
-- Object Description : Switch active tenant context and update last login timestamp
-- Object ID : 18627
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.switch_tenant_context(p_tenant_id uuid)
 RETURNS TABLE(tenant_id uuid, tenant_name character varying, tenant_slug character varying, user_role character varying, success boolean, message text)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_has_access BOOLEAN;
  v_user_record RECORD;
BEGIN
  -- Check if user has access to this tenant
  SELECT EXISTS (
    SELECT 1
    FROM org_users_mst
    WHERE user_id = auth.uid()
      AND tenant_org_id = p_tenant_id
      AND is_active = true
  ) INTO v_has_access;

  IF NOT v_has_access THEN
    RETURN QUERY
    SELECT
      NULL::UUID,
      NULL::VARCHAR,
      NULL::VARCHAR,
      NULL::VARCHAR,
      false,
      'Access denied: User does not have access to this tenant'::TEXT;
    RETURN;
  END IF;

  -- Update last login and increment login count
  UPDATE org_users_mst
  SET
    last_login_at = NOW(),
    login_count = COALESCE(login_count, 0) + 1,
    updated_at = NOW()
  WHERE user_id = auth.uid()
    AND tenant_org_id = p_tenant_id
  RETURNING * INTO v_user_record;

  -- Log the tenant switch
  PERFORM log_audit_event(
    auth.uid(),
    p_tenant_id,
    'tenant_switch',
    'tenant',
    p_tenant_id,
    NULL,
    jsonb_build_object('tenant_id', p_tenant_id, 'timestamp', NOW()),
    NULL,
    NULL,
    NULL,
    'success',
    NULL
  );

  -- Return tenant info
  RETURN QUERY
  SELECT
    t.id AS tenant_id,
    t.name AS tenant_name,
    t.slug AS tenant_slug,
    v_user_record.role AS user_role,
    true AS success,
    'Tenant context switched successfully'::TEXT AS message
  FROM org_tenants_mst t
  WHERE t.id = p_tenant_id;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ SWITCH_TENANT_CONTEXT ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_CREATE_INITIAL_STATUS_HISTORY
-- Object Description : Auto-creates initial status history entry when order is created
-- Object ID : 18860
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_create_initial_status_history()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Create initial status history entry when order is created
  INSERT INTO org_order_status_history (
    order_id,
    tenant_org_id,
    from_status,
    to_status,
    changed_by,
    changed_by_name,
    notes
  ) VALUES (
    NEW.id,
    NEW.tenant_org_id,
    NULL,
    NEW.status,
    auth.uid(),
    'System',
    'Order created'
  );

  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ FN_CREATE_INITIAL_STATUS_HISTORY ] 
--=====================================
                   |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_PRODUCT_PRICE
-- Object Description : Get active price for a product considering price lists and quantity tiers
-- Object ID : 18931
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_product_price(p_tenant_org_id uuid, p_product_id uuid, p_price_list_type character varying DEFAULT 'standard'::character varying, p_quantity integer DEFAULT 1, p_effective_date date DEFAULT CURRENT_DATE)
 RETURNS numeric
 LANGUAGE plpgsql
 STABLE
AS $function$
DECLARE
  v_price NUMERIC(10,3);
BEGIN
  -- Get price from active price list
  SELECT pli.price * (1 - COALESCE(pli.discount_percent, 0) / 100)
  INTO v_price
  FROM org_price_list_items_dtl pli
  JOIN org_price_lists_mst pl ON pli.price_list_id = pl.id
  WHERE pli.tenant_org_id = p_tenant_org_id
    AND pli.product_id = p_product_id
    AND pli.is_active = true
    AND pl.is_active = true
    AND pl.price_list_type = p_price_list_type
    AND (pl.effective_from IS NULL OR pl.effective_from <= p_effective_date)
    AND (pl.effective_to IS NULL OR pl.effective_to >= p_effective_date)
    AND pli.min_quantity <= p_quantity
    AND (pli.max_quantity IS NULL OR pli.max_quantity >= p_quantity)
  ORDER BY pl.priority DESC, pli.min_quantity DESC
  LIMIT 1;
  
  -- If no price list price found, fall back to product default price
  IF v_price IS NULL THEN
    SELECT 
      CASE 
        WHEN p_price_list_type = 'express' THEN COALESCE(default_express_sell_price, default_sell_price)
        ELSE default_sell_price
      END
    INTO v_price
    FROM org_product_data_mst
    WHERE tenant_org_id = p_tenant_org_id
      AND id = p_product_id
      AND is_active = true;
  END IF;
  
  RETURN v_price;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ GET_PRODUCT_PRICE ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_NEXT_ORDER_ITEM_SRNO
-- Object Description : 
-- Object ID : 18936
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_next_order_item_srno(p_tenant uuid, p_order uuid)
 RETURNS text
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_next_num integer;
BEGIN
  SELECT COALESCE(MAX((CASE WHEN order_item_srno ~ '^\\d+$' THEN order_item_srno::int ELSE 0 END)), 0) + 1
    INTO v_next_num
  FROM org_order_items_dtl
  WHERE tenant_org_id = p_tenant
    AND order_id = p_order;

  -- Return zero-padded 3+ width (e.g., 001, 012, 120)
  RETURN lpad(v_next_num::text, 3, '0');
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ FN_NEXT_ORDER_ITEM_SRNO ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_AFTER_ITEM_CHANGE_RECALC
-- Object Description : 
-- Object ID : 18940
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_after_item_change_recalc()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_tenant uuid;
  v_order uuid;
BEGIN
  IF (TG_OP = 'INSERT' OR TG_OP = 'UPDATE') THEN
    v_tenant := NEW.tenant_org_id;
    v_order  := NEW.order_id;
  ELSE
    v_tenant := OLD.tenant_org_id;
    v_order  := OLD.order_id;
  END IF;

  PERFORM fn_recalc_order_totals(v_tenant, v_order);
  RETURN COALESCE(NEW, OLD);
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 
****** End Of Object Info ****** [ TRG_AFTER_ITEM_CHANGE_RECALC ] 
--=====================================
                       |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : IS_ITEM_ALL_STEPS_DONE
-- Object Description : Check if all 5 processing steps are completed for an order item
-- Object ID : 19192
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.is_item_all_steps_done(p_order_item_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE
AS $function$
DECLARE
  v_expected_steps INTEGER := 5;
  v_completed_steps INTEGER;
BEGIN
  SELECT COUNT(DISTINCT step_code) INTO v_completed_steps
  FROM org_order_item_processing_steps
  WHERE order_item_id = p_order_item_id;

  RETURN v_completed_steps >= v_expected_steps;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 
****** End Of Object Info ****** [ IS_ITEM_ALL_STEPS_DONE ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_UNRESOLVED_ISSUES
-- Object Description : Check if an order item has unresolved issues
-- Object ID : 19193
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_unresolved_issues(p_order_item_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM org_order_item_issues
    WHERE order_item_id = p_order_item_id
    AND solved_at IS NULL
  );
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 
****** End Of Object Info ****** [ HAS_UNRESOLVED_ISSUES ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_SET_ORDER_ITEM_SRNO
-- Object Description : 
-- Object ID : 18937
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_set_order_item_srno()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.order_item_srno IS NULL OR NEW.order_item_srno = '' THEN
    NEW.order_item_srno := fn_next_order_item_srno(NEW.tenant_org_id, NEW.order_id);
  END IF;
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ TRG_SET_ORDER_ITEM_SRNO ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_RECALC_ORDER_TOTALS
-- Object Description : 
-- Object ID : 18939
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_recalc_order_totals(p_tenant uuid, p_order uuid)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_total_items integer := 0;
  v_subtotal numeric(10,3) := 0;
  v_discount numeric(10,3) := 0;
  v_tax numeric(10,3) := 0;
BEGIN
  SELECT COALESCE(SUM(quantity), 0), COALESCE(SUM(total_price), 0)
    INTO v_total_items, v_subtotal
  FROM org_order_items_dtl
  WHERE tenant_org_id = p_tenant
    AND order_id = p_order;

  -- Get existing discount/tax from order; preserve values
  SELECT COALESCE(discount, 0), COALESCE(tax, 0)
    INTO v_discount, v_tax
  FROM org_orders_mst
  WHERE tenant_org_id = p_tenant AND id = p_order;

  UPDATE org_orders_mst
  SET total_items = v_total_items,
      subtotal    = v_subtotal,
      total       = (v_subtotal - v_discount + v_tax),
      updated_at  = NOW()
  WHERE tenant_org_id = p_tenant AND id = p_order;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ FN_RECALC_ORDER_TOTALS ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : LOG_ORDER_ACTION
-- Object Description : Log an action to order history
-- Object ID : 19230
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.log_order_action(p_tenant_org_id uuid, p_order_id uuid, p_action_type text, p_from_value text DEFAULT NULL::text, p_to_value text DEFAULT NULL::text, p_done_by uuid DEFAULT NULL::uuid, p_payload jsonb DEFAULT '{}'::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_history_id UUID;
BEGIN
  INSERT INTO org_order_history (
    tenant_org_id,
    order_id,
    action_type,
    from_value,
    to_value,
    payload,
    done_by,
    done_at
  )
  VALUES (
    p_tenant_org_id,
    p_order_id,
    p_action_type,
    p_from_value,
    p_to_value,
    p_payload,
    p_done_by,
    now()
  )
  RETURNING id INTO v_history_id;

  RETURN v_history_id;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 
****** End Of Object Info ****** [ LOG_ORDER_ACTION ] 
--=====================================
                                   |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : ORDER_HAS_ACTION
-- Object Description : Check if order has a specific action type
-- Object ID : 19232
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.order_has_action(p_order_id uuid, p_action_type text)
 RETURNS boolean
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM org_order_history
    WHERE order_id = p_order_id 
    AND action_type = p_action_type
  );
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 
****** End Of Object Info ****** [ ORDER_HAS_ACTION ] 
--=====================================
                                   |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_AUTO_LOG_ORDER_CREATED
-- Object Description : Auto-log order creation to history
-- Object ID : 19233
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_auto_log_order_created()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  PERFORM log_order_action(
    NEW.tenant_org_id,
    NEW.id,
    'ORDER_CREATED',
    NULL,
    NEW.current_status,
    auth.uid(),
    jsonb_build_object(
      'order_no', NEW.order_no,
      'customer_id', NEW.customer_id,
      'is_quick_drop', NEW.is_order_quick_drop,
      'order_type_id', NEW.order_type_id,
      'created_via', 'system_trigger'
    )
  );
  
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
****** End Of Object Info ****** [ FN_AUTO_LOG_ORDER_CREATED ] 
--=====================================
                          |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_ORDER_TIMELINE
-- Object Description : Get complete timeline for an order
-- Object ID : 19231
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_order_timeline(p_order_id uuid)
 RETURNS TABLE(id uuid, action_type text, from_value text, to_value text, done_by uuid, done_at timestamp with time zone, payload jsonb)
 LANGUAGE plpgsql
 STABLE
AS $function$
BEGIN
  RETURN QUERY
  SELECT 
    oh.id,
    oh.action_type,
    oh.from_value,
    oh.to_value,
    oh.done_by,
    oh.done_at,
    oh.payload
  FROM org_order_history oh
  WHERE oh.order_id = p_order_id
  ORDER BY oh.done_at DESC;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 
****** End Of Object Info ****** [ GET_ORDER_TIMELINE ] 
--=====================================
                                 |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : LOG_AUDIT_EVENT
-- Object Description : Helper function to log audit events consistently
-- Object ID : 18607
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.log_audit_event(p_user_id uuid, p_tenant_org_id uuid, p_action character varying, p_entity_type character varying DEFAULT NULL::character varying, p_entity_id uuid DEFAULT NULL::uuid, p_old_values jsonb DEFAULT NULL::jsonb, p_new_values jsonb DEFAULT NULL::jsonb, p_ip_address inet DEFAULT NULL::inet, p_user_agent text DEFAULT NULL::text, p_request_id character varying DEFAULT NULL::character varying, p_status character varying DEFAULT 'success'::character varying, p_error_message text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_log_id UUID;
BEGIN
  INSERT INTO sys_audit_log (
    user_id,
    tenant_org_id,
    action,
    entity_type,
    entity_id,
    old_values,
    new_values,
    ip_address,
    user_agent,
    request_id,
    status,
    error_message
  ) VALUES (
    p_user_id,
    p_tenant_org_id,
    p_action,
    p_entity_type,
    p_entity_id,
    p_old_values,
    p_new_values,
    p_ip_address,
    p_user_agent,
    p_request_id,
    p_status,
    p_error_message
  )
  RETURNING id INTO v_log_id;

  RETURN v_log_id;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 
****** End Of Object Info ****** [ LOG_AUDIT_EVENT ] 
--=====================================
                                    |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UPDATE_USER_LAST_LOGIN
-- Object Description : 
-- Object ID : 18608
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.update_user_last_login()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- This trigger will be called from application code via function call
  -- when user successfully authenticates
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 
****** End Of Object Info ****** [ UPDATE_USER_LAST_LOGIN ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CURRENT_TENANT_ID
-- Object Description : Extract tenant_org_id from JWT claims
-- Object ID : 18610
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.current_tenant_id()
 RETURNS uuid
 LANGUAGE sql
 STABLE
AS $function$
  SELECT NULLIF(
    current_setting('request.jwt.claims', true)::json->>'tenant_org_id',
    ''
  )::UUID;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ CURRENT_TENANT_ID ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CURRENT_USER_ID
-- Object Description : Extract user ID (sub claim) from JWT
-- Object ID : 18611
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.current_user_id()
 RETURNS uuid
 LANGUAGE sql
 STABLE
AS $function$
  SELECT COALESCE(
    NULLIF(current_setting('request.jwt.claims', true)::json->>'sub', '')::UUID,
    auth.uid()
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ CURRENT_USER_ID ] 
--=====================================
                                    |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CURRENT_USER_ROLE
-- Object Description : Get current user role within active tenant
-- Object ID : 18612
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.current_user_role()
 RETURNS character varying
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT role
  FROM org_users_mst
  WHERE user_id = auth.uid()
    AND tenant_org_id = current_tenant_id()
    AND is_active = true
  LIMIT 1;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ CURRENT_USER_ROLE ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : IS_ACCOUNT_LOCKED
-- Object Description : Check if account is currently locked based on email
-- Object ID : 18632
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.is_account_locked(p_email character varying)
 RETURNS TABLE(is_locked boolean, locked_until timestamp without time zone, lock_reason character varying, user_id uuid)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_record RECORD;
BEGIN
  -- Get user from auth.users and check lock status in org_users_mst
  SELECT
    au.id,
    ou.locked_until,
    ou.lock_reason
  INTO v_user_record
  FROM auth.users au
  LEFT JOIN org_users_mst ou ON au.id = ou.user_id
  WHERE au.email = p_email
  LIMIT 1;

  IF NOT FOUND THEN
    -- User doesn't exist
    RETURN QUERY SELECT false, NULL::TIMESTAMP, NULL::VARCHAR, NULL::UUID;
    RETURN;
  END IF;

  -- Check if locked and lock hasn't expired
  IF v_user_record.locked_until IS NOT NULL
     AND v_user_record.locked_until > NOW() THEN
    RETURN QUERY SELECT
      true,
      v_user_record.locked_until,
      v_user_record.lock_reason,
      v_user_record.id;
  ELSE
    -- Not locked or lock has expired
    RETURN QUERY SELECT
      false,
      NULL::TIMESTAMP,
      NULL::VARCHAR,
      v_user_record.id;
  END IF;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 
****** End Of Object Info ****** [ IS_ACCOUNT_LOCKED ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : RECORD_LOGIN_ATTEMPT
-- Object Description : Record login attempt and handle account lockout logic
-- Object ID : 18633
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.record_login_attempt(p_email character varying, p_success boolean, p_ip_address inet DEFAULT NULL::inet, p_user_agent text DEFAULT NULL::text, p_error_message text DEFAULT NULL::text)
 RETURNS TABLE(log_id uuid, is_locked boolean, locked_until timestamp without time zone, lock_reason character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_user_id UUID;
  v_log_id UUID;
  v_failed_attempts INTEGER;
  v_lock_until TIMESTAMP;
  v_lock_reason VARCHAR;
  v_is_locked BOOLEAN := false;

  -- Configuration constants
  c_max_failed_attempts CONSTANT INTEGER := 5;
  c_lockout_duration CONSTANT INTERVAL := INTERVAL '15 minutes';
  c_reset_window CONSTANT INTERVAL := INTERVAL '1 hour';
BEGIN
  -- Try to find user by email
  SELECT id INTO v_user_id
  FROM auth.users
  WHERE email = p_email
  LIMIT 1;

  -- Log the attempt in audit log
  SELECT log_audit_event(
    v_user_id,
    NULL, -- No tenant context yet
    CASE WHEN p_success THEN 'login_success' ELSE 'login_failure' END,
    'user',
    v_user_id,
    NULL,
    jsonb_build_object('email', p_email, 'timestamp', NOW()),
    p_ip_address,
    p_user_agent,
    NULL,
    CASE WHEN p_success THEN 'success' ELSE 'failure' END,
    p_error_message
  ) INTO v_log_id;

  -- If user exists, update login tracking
  IF v_user_id IS NOT NULL THEN
    IF p_success THEN
      -- Successful login - reset failed attempts
      UPDATE org_users_mst
      SET
        failed_login_attempts = 0,
        last_failed_login_at = NULL,
        locked_until = NULL,
        lock_reason = NULL,
        last_login_at = NOW(),
        login_count = COALESCE(login_count, 0) + 1,
        updated_at = NOW()
      WHERE user_id = v_user_id;
    ELSE
      -- Failed login - increment counter
      UPDATE org_users_mst
      SET
        failed_login_attempts = CASE
          -- Reset counter if last failure was more than 1 hour ago
          WHEN last_failed_login_at IS NULL
               OR last_failed_login_at < NOW() - c_reset_window
          THEN 1
          ELSE failed_login_attempts + 1
        END,
        last_failed_login_at = NOW(),
        updated_at = NOW()
      WHERE user_id = v_user_id
      RETURNING failed_login_attempts INTO v_failed_attempts;

      -- Check if we should lock the account
      IF v_failed_attempts >= c_max_failed_attempts THEN
        v_lock_until := NOW() + c_lockout_duration;
        v_lock_reason := format('Account locked due to %s failed login attempts', c_max_failed_attempts);
        v_is_locked := true;

        -- Lock the account
        UPDATE org_users_mst
        SET
          locked_until = v_lock_until,
          lock_reason = v_lock_reason,
          updated_at = NOW()
        WHERE user_id = v_user_id;

        -- Log the lockout event
        PERFORM log_audit_event(
          v_user_id,
          NULL,
          'account_locked',
          'user',
          v_user_id,
          NULL,
          jsonb_build_object(
            'locked_until', v_lock_until,
            'reason', v_lock_reason,
            'failed_attempts', v_failed_attempts
          ),
          p_ip_address,
          p_user_agent,
          NULL,
          'success',
          NULL
        );
      END IF;
    END IF;
  END IF;

  -- Return result
  RETURN QUERY SELECT
    v_log_id,
    v_is_locked,
    v_lock_until,
    v_lock_reason;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
****** End Of Object Info ****** [ RECORD_LOGIN_ATTEMPT ] 
--=====================================
                               |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UNLOCK_ACCOUNT
-- Object Description : Manually unlock a locked account (admin only)
-- Object ID : 18634
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.unlock_account(p_user_id uuid, p_admin_user_id uuid, p_reason text DEFAULT 'Manual unlock by administrator'::text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_is_admin BOOLEAN;
BEGIN
  -- Verify admin has permission (must be admin in same tenant)
  SELECT EXISTS (
    SELECT 1
    FROM org_users_mst
    WHERE user_id = p_admin_user_id
      AND role = 'admin'
      AND is_active = true
  ) INTO v_is_admin;

  IF NOT v_is_admin THEN
    RAISE EXCEPTION 'Only administrators can unlock accounts';
  END IF;

  -- Unlock the account
  UPDATE org_users_mst
  SET
    locked_until = NULL,
    lock_reason = NULL,
    failed_login_attempts = 0,
    last_failed_login_at = NULL,
    updated_at = NOW()
  WHERE user_id = p_user_id;

  -- Log the unlock event
  PERFORM log_audit_event(
    p_admin_user_id,
    NULL,
    'account_unlocked',
    'user',
    p_user_id,
    NULL,
    jsonb_build_object(
      'unlocked_by', p_admin_user_id,
      'reason', p_reason
    ),
    NULL,
    NULL,
    NULL,
    'success',
    NULL
  );

  RETURN true;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 
****** End Of Object Info ****** [ UNLOCK_ACCOUNT ] 
--=====================================
                                     |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : AUTO_UNLOCK_EXPIRED_ACCOUNTS
-- Object Description : Automatically unlock accounts with expired locks (run via cron)
-- Object ID : 18635
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.auto_unlock_expired_accounts()
 RETURNS TABLE(unlocked_count integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_count INTEGER;
BEGIN
  -- Unlock accounts where lock has expired
  UPDATE org_users_mst
  SET
    locked_until = NULL,
    lock_reason = NULL,
    updated_at = NOW()
  WHERE locked_until IS NOT NULL
    AND locked_until <= NOW();

  GET DIAGNOSTICS v_count = ROW_COUNT;

  -- Log if any accounts were unlocked
  IF v_count > 0 THEN
    PERFORM log_audit_event(
      NULL,
      NULL,
      'auto_unlock_expired',
      'system',
      NULL,
      NULL,
      jsonb_build_object(
        'unlocked_count', v_count,
        'timestamp', NOW()
      ),
      NULL,
      NULL,
      NULL,
      'success',
      NULL
    );
  END IF;

  RETURN QUERY SELECT v_count;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 
****** End Of Object Info ****** [ AUTO_UNLOCK_EXPIRED_ACCOUNTS ] 
--=====================================
                       |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : INITIALIZE_NEW_TENANT
-- Object Description : Auto-initialize new tenant with subscription, branch, services, workflows, and optional admin user
-- Object ID : 18682
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.initialize_new_tenant(p_tenant_id uuid, p_admin_email text DEFAULT NULL::text, p_admin_password text DEFAULT 'Admin123'::text, p_admin_display_name text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_tenant RECORD;
  v_subscription_id UUID;
  v_branch_id UUID;
  v_admin_user_id UUID;
  v_service_count INTEGER := 0;
  v_workflow_default_id UUID;
  v_workflow_ironing_id UUID;
  v_category_workflow_count INTEGER := 0;
  v_result JSONB;
  v_errors TEXT[] := ARRAY[]::TEXT[];
BEGIN
  -- Validate tenant exists
  SELECT * INTO v_tenant
  FROM org_tenants_mst
  WHERE id = p_tenant_id;

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Tenant not found: %', p_tenant_id;
  END IF;

  RAISE NOTICE E'\n Initializing tenant: % (%)', v_tenant.name, p_tenant_id;

  -- ==============================================================
  -- 1. CREATE SUBSCRIPTION (Free Plan, 14-day Trial)
  -- ==============================================================
  BEGIN
    INSERT INTO org_subscriptions_mst (
      id,
      tenant_org_id,
      plan,
      status,
      orders_limit,
      orders_used,
      branch_limit,
      user_limit,
      start_date,
      end_date,
      trial_ends,
      created_at
    )
    VALUES (
      gen_random_uuid(),
      p_tenant_id,
      'free',
      'trial',
      50,
      0,
      1,
      2,
      NOW(),
      NOW() + INTERVAL '14 days',
      NOW() + INTERVAL '14 days',
      NOW()
    )
    RETURNING id INTO v_subscription_id;

    RAISE NOTICE '   Subscription created (ID: %, Plan: free, Trial: 14 days)', v_subscription_id;

  EXCEPTION WHEN unique_violation THEN
    SELECT id INTO v_subscription_id
    FROM org_subscriptions_mst
    WHERE tenant_org_id = p_tenant_id
    LIMIT 1;

    RAISE NOTICE '    Subscription already exists (ID: %)', v_subscription_id;
    v_errors := array_append(v_errors, 'subscription_exists');
  END;

  -- ==============================================================
  -- 2. CREATE MAIN BRANCH (Inherit Tenant Info)
  -- ==============================================================
  BEGIN
    INSERT INTO org_branches_mst (
      id,
      tenant_org_id,
      branch_name,
      address,
      city,
      country,
      phone,
      email,
      is_active,
      created_at,
      created_by,
      created_info
    )
    VALUES (
      gen_random_uuid(),
      p_tenant_id,
      'Main Branch',
      COALESCE(v_tenant.address, ''),
      COALESCE(v_tenant.city, ''),
      COALESCE(v_tenant.country, 'OM'),
      COALESCE(v_tenant.phone, ''),
      COALESCE(v_tenant.email, ''),
      true,
      NOW(),
      'system',
      'Auto-created during tenant initialization'
    )
    RETURNING id INTO v_branch_id;

    RAISE NOTICE '   Main branch created (ID: %, Name: Main Branch)', v_branch_id;

  EXCEPTION WHEN unique_violation THEN
    SELECT id INTO v_branch_id
    FROM org_branches_mst
    WHERE tenant_org_id = p_tenant_id
    AND branch_name = 'Main Branch'
    LIMIT 1;

    RAISE NOTICE '    Main branch already exists (ID: %)', v_branch_id;
    v_errors := array_append(v_errors, 'branch_exists');
  END;

  -- ==============================================================
  -- 3. ENABLE ALL ACTIVE SERVICE CATEGORIES
  -- ==============================================================
  BEGIN
    INSERT INTO org_service_category_cf (tenant_org_id, service_category_code)
    SELECT
      p_tenant_id,
      service_category_code
    FROM sys_service_category_cd
    WHERE is_active = true
    ON CONFLICT (tenant_org_id, service_category_code) DO NOTHING;

    GET DIAGNOSTICS v_service_count = ROW_COUNT;

    RAISE NOTICE '   Service categories enabled (Count: %)', v_service_count;

  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING '    Error enabling service categories: %', SQLERRM;
    v_errors := array_append(v_errors, 'service_category_error');
  END;

  -- ==============================================================
  -- 4. CREATE DEFAULT WORKFLOW CONFIGURATIONS
  -- ==============================================================
  BEGIN
    -- Default workflow (all orders)
    INSERT INTO org_workflow_settings_cf (
      tenant_org_id,
      service_category_code,
      workflow_steps,
      status_transitions,
      quality_gate_rules,
      is_active
    )
    VALUES (
      p_tenant_id,
      NULL,
      '["DRAFT","INTAKE","PREPARATION","SORTING","WASHING","DRYING","FINISHING","ASSEMBLY","QA","PACKING","READY","OUT_FOR_DELIVERY","DELIVERED","CLOSED"]'::jsonb,
      '{
        "DRAFT": ["INTAKE", "CANCELLED"],
        "INTAKE": ["PREPARATION", "CANCELLED"],
        "PREPARATION": ["SORTING", "CANCELLED"],
        "SORTING": ["WASHING", "FINISHING", "CANCELLED"],
        "WASHING": ["DRYING", "CANCELLED"],
        "DRYING": ["FINISHING", "CANCELLED"],
        "FINISHING": ["ASSEMBLY", "PACKING", "CANCELLED"],
        "ASSEMBLY": ["QA", "CANCELLED"],
        "QA": ["PACKING", "WASHING", "CANCELLED"],
        "PACKING": ["READY", "CANCELLED"],
        "READY": ["OUT_FOR_DELIVERY", "DELIVERED", "CANCELLED"],
        "OUT_FOR_DELIVERY": ["DELIVERED", "READY", "CANCELLED"],
        "DELIVERED": ["CLOSED"],
        "CLOSED": [],
        "CANCELLED": []
      }'::jsonb,
      '{
        "READY": {
          "requireAllItemsAssembled": true,
          "requireQAPassed": true,
          "requireNoUnresolvedIssues": true
        }
      }'::jsonb,
      true
    )
    ON CONFLICT (tenant_org_id, service_category_code) DO NOTHING
    RETURNING id INTO v_workflow_default_id;

    RAISE NOTICE '   Default workflow created (ID: %)', v_workflow_default_id;

  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING '    Error creating default workflow: %', SQLERRM;
    v_errors := array_append(v_errors, 'workflow_error');
  END;

  -- Create workflows for all enabled service categories
  BEGIN
    INSERT INTO org_workflow_settings_cf (
      tenant_org_id,
      service_category_code,
      workflow_steps,
      status_transitions,
      quality_gate_rules,
      is_active
    )
    SELECT
      p_tenant_id,
      sc.service_category_code,
      CASE
        -- IRON_ONLY and IRON: Simplified workflow (no washing/drying)
        WHEN sc.service_category_code IN ('IRON_ONLY', 'IRON') THEN
          '["DRAFT","INTAKE","FINISHING","PACKING","READY","OUT_FOR_DELIVERY","DELIVERED","CLOSED"]'::jsonb
        -- All other categories: Full workflow
        ELSE
          '["DRAFT","INTAKE","PREPARATION","SORTING","WASHING","DRYING","FINISHING","ASSEMBLY","QA","PACKING","READY","OUT_FOR_DELIVERY","DELIVERED","CLOSED"]'::jsonb
      END,
      CASE
        -- IRON_ONLY and IRON: Simplified transitions
        WHEN sc.service_category_code IN ('IRON_ONLY', 'IRON') THEN
          '{
            "DRAFT": ["INTAKE", "CANCELLED"],
            "INTAKE": ["FINISHING", "CANCELLED"],
            "FINISHING": ["PACKING", "CANCELLED"],
            "PACKING": ["READY", "CANCELLED"],
            "READY": ["OUT_FOR_DELIVERY", "DELIVERED", "CANCELLED"],
            "OUT_FOR_DELIVERY": ["DELIVERED", "READY", "CANCELLED"],
            "DELIVERED": ["CLOSED"],
            "CLOSED": [],
            "CANCELLED": []
          }'::jsonb
        -- All other categories: Full transitions
        ELSE
          '{
            "DRAFT": ["INTAKE", "CANCELLED"],
            "INTAKE": ["PREPARATION", "CANCELLED"],
            "PREPARATION": ["SORTING", "CANCELLED"],
            "SORTING": ["WASHING", "FINISHING", "CANCELLED"],
            "WASHING": ["DRYING", "CANCELLED"],
            "DRYING": ["FINISHING", "CANCELLED"],
            "FINISHING": ["ASSEMBLY", "PACKING", "CANCELLED"],
            "ASSEMBLY": ["QA", "CANCELLED"],
            "QA": ["PACKING", "WASHING", "CANCELLED"],
            "PACKING": ["READY", "CANCELLED"],
            "READY": ["OUT_FOR_DELIVERY", "DELIVERED", "CANCELLED"],
            "OUT_FOR_DELIVERY": ["DELIVERED", "READY", "CANCELLED"],
            "DELIVERED": ["CLOSED"],
            "CLOSED": [],
            "CANCELLED": []
          }'::jsonb
      END,
      CASE
        -- IRON_ONLY and IRON: Relaxed quality gates
        WHEN sc.service_category_code IN ('IRON_ONLY', 'IRON') THEN
          '{
            "READY": {
              "requireAllItemsAssembled": false,
              "requireQAPassed": false,
              "requireNoUnresolvedIssues": true
            }
          }'::jsonb
        -- All other categories: Full quality gates
        ELSE
          '{
            "READY": {
              "requireAllItemsAssembled": true,
              "requireQAPassed": true,
              "requireNoUnresolvedIssues": true
            }
          }'::jsonb
      END,
      true
    FROM org_service_category_cf sc
    WHERE sc.tenant_org_id = p_tenant_id
    ON CONFLICT (tenant_org_id, service_category_code) DO NOTHING;

    GET DIAGNOSTICS v_category_workflow_count = ROW_COUNT;

    RAISE NOTICE '   Category-specific workflows created (Count: %)', v_category_workflow_count;

  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING '    Error creating category workflows: %', SQLERRM;
    -- Don't fail initialization if category workflows fail
  END;

  -- ==============================================================
  -- 5. CREATE ADMIN USER (If email provided)
  -- ==============================================================
  IF p_admin_email IS NOT NULL THEN
    BEGIN
      v_admin_user_id := create_and_link_auth_user(
        p_admin_email,
        p_admin_password,
        p_tenant_id,
        COALESCE(p_admin_display_name, split_part(p_admin_email, '@', 1)),
        'admin'
      );

      RAISE NOTICE '   Admin user created (Email: %, ID: %)', p_admin_email, v_admin_user_id;

    EXCEPTION WHEN OTHERS THEN
      RAISE WARNING '    Error creating admin user: %', SQLERRM;
      RAISE NOTICE '    You can create admin user manually later';
      v_errors := array_append(v_errors, 'admin_user_error');
    END;
  ELSE
    RAISE NOTICE '    Admin user creation skipped (no email provided)';
  END IF;

  -- ==============================================================
  -- 6. LOG INITIALIZATION IN AUDIT LOG
  -- ==============================================================
  BEGIN
    PERFORM log_audit_event(
      NULL,
      p_tenant_id,
      'tenant_initialized',
      'tenant',
      p_tenant_id,
      NULL,
      jsonb_build_object(
        'tenant_id', p_tenant_id,
        'tenant_name', v_tenant.name,
        'subscription_id', v_subscription_id,
        'branch_id', v_branch_id,
        'admin_user_id', v_admin_user_id,
        'service_categories_count', v_service_count,
        'workflow_configs_created', 1 + v_category_workflow_count
      ),
      NULL,
      NULL,
      NULL,
      'success',
      NULL
    );
  EXCEPTION WHEN OTHERS THEN
    RAISE WARNING '    Error logging to audit: %', SQLERRM;
  END;

  -- ==============================================================
  -- 7. BUILD RESULT OBJECT
  -- ==============================================================
  v_result := jsonb_build_object(
    'success', true,
    'tenant_id', p_tenant_id,
    'tenant_name', v_tenant.name,
    'resources_created', jsonb_build_object(
      'subscription_id', v_subscription_id,
      'branch_id', v_branch_id,
      'admin_user_id', v_admin_user_id,
      'service_categories_count', v_service_count,
      'workflow_configs', jsonb_build_object(
        'default_id', v_workflow_default_id,
        'category_specific_count', v_category_workflow_count
      )
    ),
    'errors', v_errors,
    'initialized_at', NOW()
  );

  RAISE NOTICE E'  \n Tenant initialization complete!';
  RAISE NOTICE '  Results: %', v_result::TEXT;

  RETURN v_result;

EXCEPTION WHEN OTHERS THEN
  RAISE WARNING ' Tenant initialization failed: %', SQLERRM;
  RETURN jsonb_build_object(
    'success', false,
    'tenant_id', p_tenant_id,
    'error', SQLERRM,
    'failed_at', NOW()
  );
END;
$function$

--===================================================
 | 
****** End Of Object Info ****** [ INITIALIZE_NEW_TENANT ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_AUTO_INITIALIZE_TENANT
-- Object Description : Trigger function to auto-initialize tenants on creation
-- Object ID : 18684
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_auto_initialize_tenant()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_result JSONB;
  v_skip_demo BOOLEAN := false;
BEGIN
  -- Skip auto-initialization for known demo/test tenants
  -- These are seeded manually with specific configurations
  IF NEW.id IN (
    '11111111-1111-1111-1111-111111111111',  -- Demo tenant
    '22222222-2222-2222-2222-222222222222'   -- Test tenant 2
  ) THEN
    RAISE NOTICE 'Skipping auto-initialization for demo/test tenant: %', NEW.id;
    RETURN NEW;
  END IF;

  -- Auto-initialize the tenant
  RAISE NOTICE 'Auto-initializing new tenant: % (%)', NEW.name, NEW.id;

  BEGIN
    v_result := initialize_new_tenant(
      NEW.id,
      NULL,  -- No admin user by default (create separately)
      NULL,
      NULL
    );

    -- Check if initialization was successful
    IF (v_result->>'success')::BOOLEAN THEN
      RAISE NOTICE 'Auto-initialization successful for tenant: %', NEW.id;
    ELSE
      RAISE WARNING 'Auto-initialization had errors for tenant: %', NEW.id;
    END IF;

  EXCEPTION WHEN OTHERS THEN
    -- Don't fail the INSERT if auto-initialization fails
    -- Just log the error
    RAISE WARNING 'Auto-initialization failed for tenant %: %', NEW.id, SQLERRM;
  END;

  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 
****** End Of Object Info ****** [ TRG_AUTO_INITIALIZE_TENANT ] 
--=====================================
                         |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GENERATE_CUSTOMER_NUMBER
-- Object Description : Generate sequential customer number per tenant (CUST-00001 format)
-- Object ID : 18753
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.generate_customer_number(p_tenant_org_id uuid)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_next_number INTEGER;
  v_customer_number VARCHAR(50);
BEGIN
  -- Get the next sequential number for this tenant
  -- This is a simplified version - in production, consider using a sequence per tenant
  SELECT COALESCE(MAX(CAST(SUBSTRING(customer_number FROM 6) AS INTEGER)), 0) + 1
  INTO v_next_number
  FROM sys_customers_mst
  WHERE first_tenant_org_id = p_tenant_org_id
    AND customer_number IS NOT NULL
    AND customer_number ~ '^CUST-[0-9]+$';

  -- Format as CUST-00001
  v_customer_number := 'CUST-' || LPAD(v_next_number::TEXT, 5, '0');

  RETURN v_customer_number;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ GENERATE_CUSTOMER_NUMBER ] 
--=====================================
                           |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CLEANUP_EXPIRED_OTP_CODES
-- Object Description : Delete OTP codes expired more than 1 hour ago
-- Object ID : 18754
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cleanup_expired_otp_codes()
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_deleted_count INTEGER;
BEGIN
  DELETE FROM sys_otp_codes
  WHERE expires_at < NOW() - INTERVAL '1 hour';

  GET DIAGNOSTICS v_deleted_count = ROW_COUNT;

  RETURN v_deleted_count;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ CLEANUP_EXPIRED_OTP_CODES ] 
--=====================================
                          |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UPDATE_CUSTOMER_ADDRESS_TIMESTAMP
-- Object Description : 
-- Object ID : 18759
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.update_customer_address_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ UPDATE_CUSTOMER_ADDRESS_TIMESTAMP ] 
--=====================================
                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : ENSURE_SINGLE_DEFAULT_ADDRESS
-- Object Description : 
-- Object ID : 18761
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.ensure_single_default_address()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.is_default = true THEN
    -- Unset other default addresses for this customer/tenant
    UPDATE org_customer_addresses
    SET is_default = false
    WHERE customer_id = NEW.customer_id
      AND tenant_org_id = NEW.tenant_org_id
      AND id != NEW.id
      AND is_default = true;
  END IF;

  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ ENSURE_SINGLE_DEFAULT_ADDRESS ] 
--=====================================
                      |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GENERATE_ORDER_NUMBER
-- Object Description : Generate unique order number per tenant per day in format ORD-YYYYMMDD-XXXX. Thread-safe with retry logic.
-- Object ID : 18777
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.generate_order_number(p_tenant_org_id uuid)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_date TEXT;
  v_sequence INTEGER;
  v_order_number TEXT;
  v_max_attempts INTEGER := 10;
  v_attempt INTEGER := 0;
BEGIN
  -- Get current date in YYYYMMDD format (tenant's timezone)
  v_date := TO_CHAR(CURRENT_DATE, 'YYYYMMDD');

  -- Loop to handle rare race conditions
  LOOP
    v_attempt := v_attempt + 1;

    -- Get next sequence number for this tenant and date
    -- Using FOR UPDATE to prevent race conditions
    SELECT COALESCE(MAX(CAST(SUBSTRING(order_no FROM 14) AS INTEGER)), 0) + 1
    INTO v_sequence
    FROM org_orders_mst
    WHERE tenant_org_id = p_tenant_org_id
      AND order_no LIKE 'ORD-' || v_date || '-%';

    -- Format: ORD-YYYYMMDD-XXXX (e.g., ORD-20251025-0001)
    v_order_number := 'ORD-' || v_date || '-' || LPAD(v_sequence::TEXT, 4, '0');

    -- Verify uniqueness
    IF NOT EXISTS (
      SELECT 1 FROM org_orders_mst
      WHERE tenant_org_id = p_tenant_org_id
        AND order_no = v_order_number
    ) THEN
      RETURN v_order_number;
    END IF;

    -- If we've tried too many times, raise exception
    IF v_attempt >= v_max_attempts THEN
      RAISE EXCEPTION 'Failed to generate unique order number after % attempts', v_max_attempts;
    END IF;

    -- Small delay before retry (1ms)
    PERFORM pg_sleep(0.001);
  END LOOP;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ GENERATE_ORDER_NUMBER ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_ORDER_NUMBER_PREFIX
-- Object Description : Get order number prefix for current date (e.g., "ORD-20251025-")
-- Object ID : 18778
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_order_number_prefix()
 RETURNS text
 LANGUAGE sql
 IMMUTABLE
AS $function$
  SELECT 'ORD-' || TO_CHAR(CURRENT_DATE, 'YYYYMMDD') || '-';
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 
****** End Of Object Info ****** [ GET_ORDER_NUMBER_PREFIX ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : EXTRACT_ORDER_SEQUENCE
-- Object Description : Extract sequence number from order number (e.g., "ORD-20251025-0001"  1)
-- Object ID : 18779
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.extract_order_sequence(p_order_no text)
 RETURNS integer
 LANGUAGE sql
 IMMUTABLE
AS $function$
  SELECT CAST(SUBSTRING(p_order_no FROM 14) AS INTEGER);
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ EXTRACT_ORDER_SEQUENCE ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_ORDER_ITEMS_TRANSITION
-- Object Description : Update Order Items Status 
-- Object ID : 19236
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_order_items_transition(p_tenant uuid, p_order uuid, p_from text, p_to text, p_user uuid DEFAULT NULL::uuid, p_payload jsonb DEFAULT '{}'::jsonb)
 RETURNS text
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_order RECORD;
  v_template_id UUID;
  v_transition_allowed BOOLEAN := false;
  v_quality_gate_passed BOOLEAN := true;
  v_error_message TEXT;
  v_result JSONB;
  v_items_updated INTEGER := 0;
  v_rack_location TEXT;
  v_notes TEXT;
  v_from TEXT:=LOWER(p_from);
  v_to TEXT:=LOWER(p_to);
  
BEGIN
  
  v_from :=LOWER(p_from);
  v_to :=LOWER(p_to);
  
  IF v_to = 'ready' THEN
    
	UPDATE org_order_items_dtl
    SET 
      item_status = 'ready',
      item_stage = 'ready'
    WHERE order_id = p_order
      AND tenant_org_id = p_tenant
      /*
	  AND ( lower(item_status) IS NULL 
	        OR 
			lower(item_status) not in( 'ready', 'out_for_delivery', 'delivered', 'closed', 'cancelled')
		  )
	  */
	  --AND item_status IS NULL OR item_status = 'intake'
	  ;
    
    GET DIAGNOSTICS v_items_updated = ROW_COUNT;
  
  ELSIF v_to = 'processing' THEN
    UPDATE org_order_items_dtl
    SET 
      item_status = 'processing',
      item_stage = 'processing'
    WHERE order_id = p_order
      AND tenant_org_id = p_tenant
      /*
	  AND ( lower(item_status) IS NULL 
	        OR 
			lower(item_status) in( 'draft', 'intake', 'preparation')
		  )
	  */
	  --AND item_status IS NULL OR item_status = 'intake'
	  ;
    
    GET DIAGNOSTICS v_items_updated = ROW_COUNT;
	
  ELSIF v_to = 'closed' THEN
    UPDATE org_order_items_dtl
    SET 
      item_status = v_to,
      item_stage = v_to
    WHERE order_id = p_order
      AND tenant_org_id = p_tenant
      /*
	  AND ( lower(item_status) IS NULL 
	        OR 
			lower(item_status) in( 'draft', 'intake', 'preparation', 'processing')
		  )
	  */
	  --AND item_status IS NULL OR item_status = 'intake'
	  ;
    
    GET DIAGNOSTICS v_items_updated = ROW_COUNT;
  
  ELSE 
    UPDATE org_order_items_dtl
    SET 
      item_status = v_to,
      item_stage = v_to
    WHERE order_id = p_order
      AND tenant_org_id = p_tenant
      
	  ;
    
    GET DIAGNOSTICS v_items_updated = ROW_COUNT;
	
  END IF;
  
  Return v_items_updated;
EXCEPTION
  WHEN OTHERS THEN
    -- Log error and return failure
    --v_error_message := SQLERRM;
	Return('ERROR:'+SQLERRM);
  
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 
****** End Of Object Info ****** [ CMX_ORDER_ITEMS_TRANSITION ] 
--=====================================
                         |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_ORDER_TRANSITION
-- Object Description : Enforce workflow transitions with template validation and quality gates
-- Object ID : 19237
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_order_transition(p_tenant uuid, p_order uuid, p_from text, p_to text, p_user uuid DEFAULT NULL::uuid, p_payload jsonb DEFAULT '{}'::jsonb)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  v_order RECORD;
  v_template_id UUID;
  v_transition_allowed BOOLEAN := false;
  v_quality_gate_passed BOOLEAN := true;
  v_error_message TEXT;
  v_result JSONB;
  v_items_updated INTEGER := 0;
  v_rack_location TEXT;
  v_notes TEXT;
  v_from TEXT:=LOWER(p_from);
  v_to TEXT:=LOWER(p_to);
  v_item_update_result TEXT;
  
BEGIN
  
  v_from :=LOWER(p_from);
  v_to :=LOWER(p_to);
  
  -- Step 1: Get order details
  SELECT 
    o.*,
    otwt.template_id as workflow_template_id,
    COALESCE(otwt.template_id, o.workflow_template_id) as resolved_template_id
  INTO v_order
  FROM org_orders_mst o
  LEFT JOIN org_tenant_workflow_templates_cf otwt 
    ON otwt.tenant_org_id = o.tenant_org_id 
    AND otwt.is_default = true 
    AND otwt.is_active = true
  WHERE o.id = p_order 
    AND o.tenant_org_id = p_tenant;

  IF NOT FOUND THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Order not found or access denied',
      'code', 'ORDER_NOT_FOUND'
    );
  END IF;

  -- Set resolved template_id
  v_template_id := v_order.resolved_template_id;

  -- Fallback to WF_STANDARD if no template
  IF v_template_id IS NULL THEN
    SELECT template_id INTO v_template_id
    FROM sys_workflow_template_cd
    WHERE template_code = 'WF_STANDARD' AND is_active = true
    LIMIT 1;
  END IF;

  -- Step 2: Validate transition is allowed in template
  SELECT EXISTS (
    SELECT 1 FROM sys_workflow_template_transitions
    WHERE template_id = v_template_id
      AND LOWER(from_stage_code) = v_from
      AND LOWER(to_stage_code) = v_to
      AND is_active = true
      AND allow_manual = true
  ) INTO v_transition_allowed;

  IF NOT v_transition_allowed THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', format('Transition from %s to %s not allowed', p_from, p_to),
      'code', 'TRANSITION_NOT_ALLOWED',
      'from', p_from,
      'to', p_to,
      'template_id', v_template_id
    );
  END IF;

  -- Step 3: Quality gate checks
  IF v_to = 'ready' THEN
    -- Check rack_location is set
    v_rack_location := COALESCE(
      (p_payload->>'rack_location')::TEXT,
      v_order.rack_location
    );

    IF v_rack_location IS NULL OR v_rack_location = '' THEN
      RETURN jsonb_build_object(
        'success', false,
        'error', 'Rack location is required before moving to READY status',
        'code', 'QUALITY_GATE_FAILED',
        'gate', 'rack_location_required'
      );
    END IF;
  END IF;

  -- Step 4: Extract optional notes from payload
  v_notes := p_payload->>'notes';
  
  
  -- Step 5: Update org_orders_mst
  IF v_to='ready' THEN
      	  
	  UPDATE org_orders_mst
	  SET 
		status=v_to,
		current_status = v_to,
		current_stage = v_to,
		ready_at=now(),
		last_transition_at = now(),
		last_transition_by = p_user,
		rack_location = COALESCE((p_payload->>'rack_location')::TEXT, rack_location),
		updated_at = now()
	  WHERE id = p_order AND tenant_org_id = p_tenant
	  RETURNING * INTO v_order;
	  
  ELSIF v_to='delivered' THEN
      	  
	  UPDATE org_orders_mst
	  SET 
		status=v_to,
		current_status = v_to,
		current_stage = v_to,
		delivered_at=now(),
		--delivered_note=COALESCE((p_payload->>'delivered_note')::TEXT, delivered_note),
		last_transition_at = now(),
		last_transition_by = p_user,
		updated_at = now()
	  WHERE id = p_order AND tenant_org_id = p_tenant
	  RETURNING * INTO v_order;
	  
  ELSIF v_to='closed' THEN
      	  
	  UPDATE org_orders_mst
	  SET
		status=v_to,
		current_status = v_to,
		current_stage = v_to,
		delivered_at=COALESCE(delivered_at, now()),
		--closed_at=now(),
		--closed_note=COALESCE((p_payload->>'closed_note')::TEXT, closed_note),
		last_transition_at = now(),
		last_transition_by = p_user,
		updated_at = now()
	  WHERE id = p_order AND tenant_org_id = p_tenant
	  RETURNING * INTO v_order;
	  
  ELSIF v_to='cancelled' THEN
      	  
	  UPDATE org_orders_mst
	  SET 
		status=v_to,
		current_status = v_to,
		current_stage = v_to,
		--cancelled_at=now(),
		--cancelled_note=COALESCE((p_payload->>'cancelled_note')::TEXT, cancelled_note),
		last_transition_at = now(),
		last_transition_by = p_user,
		updated_at = now()
	  WHERE id = p_order AND tenant_org_id = p_tenant
	  RETURNING * INTO v_order;
	  
  ELSE
	  
	  UPDATE org_orders_mst
	  SET 
		status=v_to,
		current_status = v_to,
		current_stage = v_to,
		last_transition_at = now(),
		last_transition_by = p_user,
		rack_location = COALESCE((p_payload->>'rack_location')::TEXT, rack_location),
		updated_at = now()
	  WHERE id = p_order AND tenant_org_id = p_tenant
	  RETURNING * INTO v_order;
  
  END IF;
  
  -- Step 6: Bulk-update items if transitioning to processing
  v_item_update_result:=cmx_order_items_transition(
	  p_tenant,
	  p_order,
	  p_from,
	  p_to,
	  p_user
  );
  
  IF SUBSTR(v_item_update_result, 1, 5) = 'ERROR' THEN
    v_items_updated:=0;
  END IF;
  
  -- Step 7: Insert into org_order_history
  PERFORM log_order_action(
    p_tenant,
    p_order,
    'STATUS_CHANGE',
    p_from,
    p_to,
    p_user,
    jsonb_build_object(
      'template_id', v_template_id,
      'items_updated', v_items_updated,
      'notes', v_notes,
      'payload', p_payload
    )
  );

  -- Step 8: Build success result
  v_result := jsonb_build_object(
    'success', true,
    'order_id', p_order,
    'from_status', p_from,
    'to_status', p_to,
    'template_id', v_template_id,
    'items_updated', v_items_updated,
    'rack_location', v_order.rack_location,
    'transitioned_at', now()
  );

  RETURN v_result;

EXCEPTION
  WHEN OTHERS THEN
    -- Log error and return failure
    v_error_message := SQLERRM;
    
    RETURN jsonb_build_object(
      'success', false,
      'error', v_error_message,
      'code', 'TRANSITION_ERROR',
      'from', p_from,
      'to', p_to
    );
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 
****** End Of Object Info ****** [ CMX_ORDER_TRANSITION ] 
--=====================================
                               |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_VALIDATE_TRANSITION
-- Object Description : Validate if a workflow transition is allowed without executing it
-- Object ID : 19241
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_validate_transition(p_tenant uuid, p_order uuid, p_from text, p_to text)
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
AS $function$
DECLARE
  v_order RECORD;
  v_template_id UUID;
  v_transition_allowed BOOLEAN := false;
  v_result JSONB;
  v_quality_gates JSONB;
  v_from TEXT:=LOWER(p_from);
  v_to TEXT:=LOWER(p_to);
  
BEGIN
  
  v_from :=LOWER(p_from);
  v_to :=LOWER(p_to);
  
  -- Get order details
  SELECT 
    o.*,
    otwt.template_id as workflow_template_id,
    COALESCE(otwt.template_id, o.workflow_template_id) as resolved_template_id
  INTO v_order
  FROM org_orders_mst o
  LEFT JOIN org_tenant_workflow_templates_cf otwt 
    ON otwt.tenant_org_id = o.tenant_org_id 
    AND otwt.is_default = true 
    AND otwt.is_active = true
  WHERE o.id = p_order 
    AND o.tenant_org_id = p_tenant;

  IF NOT FOUND THEN
    RETURN jsonb_build_object(
      'allowed', false,
      'error', 'Order not found',
      'code', 'ORDER_NOT_FOUND'
    );
  END IF;

  v_template_id := v_order.resolved_template_id;

  -- Fallback to WF_STANDARD
  IF v_template_id IS NULL THEN
    SELECT template_id INTO v_template_id
    FROM sys_workflow_template_cd
    WHERE template_code = 'WF_STANDARD' AND is_active = true
    LIMIT 1;
  END IF;

  -- Check if transition is allowed
  SELECT EXISTS (
    SELECT 1 FROM sys_workflow_template_transitions
    WHERE template_id = v_template_id
      AND LOWER(from_stage_code) = v_from
      AND LOWER(to_stage_code) = v_to
      AND is_active = true
      AND allow_manual = true
  ) INTO v_transition_allowed;

  -- Check quality gates
  v_quality_gates := jsonb_build_object();

  IF p_to = 'ready' THEN
    IF v_order.rack_location IS NULL THEN
      v_quality_gates := jsonb_build_object(
        'passed', false,
        'required', 'rack_location'
      );
    ELSE
      v_quality_gates := jsonb_build_object('passed', true);
    END IF;
  ELSE
    v_quality_gates := jsonb_build_object('passed', true);
  END IF;

  v_result := jsonb_build_object(
    'allowed', v_transition_allowed,
    'template_id', v_template_id,
    'quality_gates', v_quality_gates,
    'from', p_from,
    'to', p_to
  );

  IF NOT v_transition_allowed THEN
    v_result := v_result || jsonb_build_object(
      'error', format('Transition from %s to %s not allowed', p_from, p_to),
      'code', 'TRANSITION_NOT_ALLOWED'
    );
  END IF;

  RETURN v_result;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | 
****** End Of Object Info ****** [ CMX_VALIDATE_TRANSITION ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_GET_ALLOWED_TRANSITIONS
-- Object Description : Get all allowed transitions for an order from current status
-- Object ID : 19242
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_get_allowed_transitions(p_tenant uuid, p_order uuid, p_from text DEFAULT NULL::text)
 RETURNS jsonb
 LANGUAGE plpgsql
 STABLE SECURITY DEFINER
AS $function$
DECLARE
  v_order RECORD;
  v_template_id UUID;
  v_allowed JSONB;
  v_current_status TEXT;
  v_from TEXT:=LOWER(p_from);
  
BEGIN
  -- Get order details
  SELECT 
    o.*,
    COALESCE(otwt.template_id, o.workflow_template_id) as resolved_template_id
  INTO v_order
  FROM org_orders_mst o
  LEFT JOIN org_tenant_workflow_templates_cf otwt 
    ON otwt.tenant_org_id = o.tenant_org_id 
    AND otwt.is_default = true 
    AND otwt.is_active = true
  WHERE o.id = p_order 
    AND o.tenant_org_id = p_tenant;

  IF NOT FOUND THEN
    RETURN jsonb_build_object(
      'success', false,
      'error', 'Order not found',
      'transitions', '[]'::jsonb
    );
  END IF;

  v_template_id := v_order.resolved_template_id;
  v_current_status := LOWER(COALESCE(p_from, v_order.current_status));

  -- Fallback to WF_STANDARD
  IF v_template_id IS NULL THEN
    SELECT template_id INTO v_template_id
    FROM sys_workflow_template_cd
    WHERE template_code = 'WF_STANDARD' AND is_active = true
    LIMIT 1;
  END IF;

  -- Get allowed transitions
  SELECT jsonb_agg(
    jsonb_build_object(
      'to', to_stage_code,
      'requires_scan', requires_scan_ok,
      'requires_invoice', requires_invoice,
      'requires_pod', requires_pod,
      'allow_manual', allow_manual,
      'auto_when_done', auto_when_done
    )
  ) INTO v_allowed
  FROM sys_workflow_template_transitions
  WHERE template_id = v_template_id
    AND from_stage_code = v_current_status
    AND is_active = true;

  IF v_allowed IS NULL THEN
    v_allowed := '[]'::jsonb;
  END IF;

  RETURN jsonb_build_object(
    'success', true,
    'from_status', v_current_status,
    'template_id', v_template_id,
    'transitions', v_allowed
  );
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ CMX_GET_ALLOWED_TRANSITIONS ] 
--=====================================
                        |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_GET_SETTING_VALUE
-- Object Description : 
-- Object ID : 19454
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_get_setting_value(p_tenant_org_id uuid, p_setting_code text)
 RETURNS json
 LANGUAGE plpgsql
AS $function$
DECLARE
  r RECORD;
  v_result json;
BEGIN
  -- 1. Try tenant-level record
  SELECT
    s.setting_value,
    s.setting_value_type,
    s.is_active,
    'tenant' AS source
  INTO r
  FROM org_tenant_settings_cf s
  WHERE s.tenant_org_id = p_tenant_org_id
    AND s.setting_code  = p_setting_code
  ORDER BY
    (s.user_id IS NOT NULL) DESC,
    (s.branch_id IS NOT NULL) DESC,
    s.updated_at DESC NULLS LAST,
    s.created_at DESC
  LIMIT 1;

  -- 2. If no tenant record, use system default
  IF NOT FOUND THEN
    SELECT
      s.setting_value,
      s.setting_value_type,
      s.is_active,
      'system' AS source
    INTO r
    FROM sys_tenant_settings_cd s
    WHERE s.setting_code = p_setting_code;
  END IF;

  -- 3. If still null, default false/null result
  IF r.setting_value IS NULL THEN
    RETURN json_build_object(
      'value', NULL,
      'type', NULL,
      'is_active', false,
      'source', 'none'
    );
  END IF;

  -- 4. Coerce value according to type
  CASE r.setting_value_type
    WHEN 'BOOLEAN' THEN
      v_result := json_build_object(
        'value', (r.setting_value::boolean),
        'type', 'BOOLEAN',
        'is_active', r.is_active,
        'source', r.source
      );
    WHEN 'NUMBER' THEN
      v_result := json_build_object(
        'value', (r.setting_value::numeric),
        'type', 'NUMBER',
        'is_active', r.is_active,
        'source', r.source
      );
    WHEN 'DATE' THEN
      v_result := json_build_object(
        'value', (r.setting_value::timestamptz),
        'type', 'DATE',
        'is_active', r.is_active,
        'source', r.source
      );
    ELSE
      v_result := json_build_object(
        'value', r.setting_value,
        'type', 'TEXT',
        'is_active', r.is_active,
        'source', r.source
      );
  END CASE;

  RETURN v_result;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 
****** End Of Object Info ****** [ FN_GET_SETTING_VALUE ] 
--=====================================
                               |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : FN_IS_SETTING_ALLOWED
-- Object Description : 
-- Object ID : 19455
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.fn_is_setting_allowed(p_tenant_org_id uuid, p_setting_code text)
 RETURNS boolean
 LANGUAGE sql
AS $function$
SELECT COALESCE(
  (fn_get_setting_value(p_tenant_org_id, p_setting_code)->>'value')::boolean,
  false
);
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 
****** End Of Object Info ****** [ FN_IS_SETTING_ALLOWED ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_CAN
-- Object Description : Fast permission check using effective_permissions table (O(1) lookup for RLS)
-- Object ID : 19790
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_can(p_perm text, p_resource_type text DEFAULT NULL::text, p_resource_id uuid DEFAULT NULL::uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM cmx_effective_permissions ep
    WHERE ep.user_id = auth.uid()
      AND ep.tenant_org_id = current_tenant_id()
      AND ep.permission_code = p_perm
      AND (
        -- Match tenant-wide permissions (resource_type IS NULL)
        (ep.resource_type IS NULL AND p_resource_type IS NULL)
        OR
        -- Match resource-scoped permissions
        (ep.resource_type = p_resource_type AND ep.resource_id = p_resource_id)
        OR
        -- Match tenant-wide permission when checking resource-scoped (fallback)
        (ep.resource_type IS NULL AND p_resource_type IS NOT NULL)
      )
      AND ep.allow = true
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ CMX_CAN ] 
--=====================================
                                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_USER_PERMISSIONS
-- Object Description : Get all permissions for current user (tenant-wide and resource-scoped)
-- Object ID : 19791
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_user_permissions()
 RETURNS TABLE(permission_code text, resource_type text, resource_id uuid)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT DISTINCT
    ep.permission_code,
    ep.resource_type,
    ep.resource_id
  FROM cmx_effective_permissions ep
  WHERE ep.user_id = auth.uid()
    AND ep.tenant_org_id = current_tenant_id()
    AND ep.allow = true;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 
****** End Of Object Info ****** [ GET_USER_PERMISSIONS ] 
--=====================================
                               |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_PERMISSION
-- Object Description : Check if current user has specific permission (tenant-wide)
-- Object ID : 19792
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_permission(p_permission text)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT cmx_can(p_permission, NULL, NULL);
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ HAS_PERMISSION ] 
--=====================================
                                     |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_RESOURCE_PERMISSION
-- Object Description : Check if current user has resource-scoped permission
-- Object ID : 19793
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_resource_permission(p_permission text, p_resource_type text, p_resource_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT cmx_can(p_permission, p_resource_type, p_resource_id);
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ HAS_RESOURCE_PERMISSION ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_ANY_PERMISSION
-- Object Description : Check if current user has any of the specified permissions
-- Object ID : 19794
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_any_permission(p_permissions text[])
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM unnest(p_permissions) AS perm
    WHERE cmx_can(perm, NULL, NULL)
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ HAS_ANY_PERMISSION ] 
--=====================================
                                 |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_ALL_PERMISSIONS
-- Object Description : Check if current user has all of the specified permissions
-- Object ID : 19795
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_all_permissions(p_permissions text[])
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT (
    SELECT COUNT(*) = array_length(p_permissions, 1)
    FROM unnest(p_permissions) AS perm
    WHERE cmx_can(perm, NULL, NULL)
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ HAS_ALL_PERMISSIONS ] 
--=====================================
                                |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_USER_ROLES
-- Object Description : Get all roles for current user in active tenant
-- Object ID : 19796
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_user_roles()
 RETURNS TABLE(role_id uuid, role_code text, role_name text)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT DISTINCT
    sr.role_id,
    sr.code AS role_code,
    sr.name AS role_name
  FROM org_auth_user_roles our
  JOIN sys_auth_roles sr ON sr.role_id = our.role_id
  WHERE our.user_id = auth.uid()
    AND our.tenant_org_id = current_tenant_id()
    AND our.is_active = true;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 
****** End Of Object Info ****** [ GET_USER_ROLES ] 
--=====================================
                                     |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_USER_WORKFLOW_ROLES
-- Object Description : Get all workflow roles for current user in active tenant (supports multiple workflow roles)
-- Object ID : 19797
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_user_workflow_roles()
 RETURNS TABLE(workflow_role text)
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT DISTINCT
    uwr.workflow_role
  FROM org_auth_user_workflow_roles uwr
  WHERE uwr.user_id = auth.uid()
    AND uwr.tenant_org_id = current_tenant_id()
    AND uwr.is_active = true;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ GET_USER_WORKFLOW_ROLES ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HAS_WORKFLOW_ROLE
-- Object Description : Check if current user has specific workflow role
-- Object ID : 19798
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.has_workflow_role(p_workflow_role text)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM org_auth_user_workflow_roles uwr
    WHERE uwr.user_id = auth.uid()
      AND uwr.tenant_org_id = current_tenant_id()
      AND uwr.workflow_role = p_workflow_role
      AND uwr.is_active = true
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 
****** End Of Object Info ****** [ HAS_WORKFLOW_ROLE ] 
--=====================================
                                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_CMX_REBUILD_FROM_ORG_USER_ROLES
-- Object Description : 
-- Object ID : 19799
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_cmx_rebuild_from_org_user_roles()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF TG_OP = 'DELETE' THEN
    PERFORM cmx_rebuild_user_permissions(OLD.user_id, OLD.tenant_org_id);
    RETURN OLD;
  ELSE
    PERFORM cmx_rebuild_user_permissions(NEW.user_id, NEW.tenant_org_id);
    RETURN NEW;
  END IF;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 
****** End Of Object Info ****** [ TRG_CMX_REBUILD_FROM_ORG_USER_ROLES ] 
--=====================================
                |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_CMX_REBUILD_FROM_ORG_USER_RESOURCE_ROLES
-- Object Description : 
-- Object ID : 19801
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_cmx_rebuild_from_org_user_resource_roles()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF TG_OP = 'DELETE' THEN
    PERFORM cmx_rebuild_user_permissions(OLD.user_id, OLD.tenant_org_id);
    RETURN OLD;
  ELSE
    PERFORM cmx_rebuild_user_permissions(NEW.user_id, NEW.tenant_org_id);
    RETURN NEW;
  END IF;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ TRG_CMX_REBUILD_FROM_ORG_USER_RESOURCE_ROLES ] 
--=====================================
       |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_CMX_REBUILD_FROM_ORG_USER_PERMISSIONS
-- Object Description : 
-- Object ID : 19803
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_cmx_rebuild_from_org_user_permissions()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF TG_OP = 'DELETE' THEN
    PERFORM cmx_rebuild_user_permissions(OLD.user_id, OLD.tenant_org_id);
    RETURN OLD;
  ELSE
    PERFORM cmx_rebuild_user_permissions(NEW.user_id, NEW.tenant_org_id);
    RETURN NEW;
  END IF;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 
****** End Of Object Info ****** [ TRG_CMX_REBUILD_FROM_ORG_USER_PERMISSIONS ] 
--=====================================
          |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : TRG_CMX_REBUILD_FROM_ORG_USER_RESOURCE_PERMISSIONS
-- Object Description : 
-- Object ID : 19805
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.trg_cmx_rebuild_from_org_user_resource_permissions()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  IF TG_OP = 'DELETE' THEN
    PERFORM cmx_rebuild_user_permissions(OLD.user_id, OLD.tenant_org_id);
    RETURN OLD;
  ELSE
    PERFORM cmx_rebuild_user_permissions(NEW.user_id, NEW.tenant_org_id);
    RETURN NEW;
  END IF;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ TRG_CMX_REBUILD_FROM_ORG_USER_RESOURCE_PERMISSIONS ] 
--=====================================
 |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CHECK_RBAC_MIGRATION_STATUS
-- Object Description : Check which users still need RBAC migration
-- Object ID : 19846
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.check_rbac_migration_status()
 RETURNS TABLE(user_id uuid, tenant_org_id uuid, old_role text, has_rbac_role boolean, rbac_roles text[])
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT
    oum.user_id,
    oum.tenant_org_id,
    oum.role AS old_role,
    EXISTS (
      SELECT 1
      FROM org_auth_user_roles oaur
      WHERE oaur.user_id = oum.user_id
        AND oaur.tenant_org_id = oum.tenant_org_id
        AND oaur.is_active = true
    ) AS has_rbac_role,
    COALESCE(
      ARRAY_AGG(DISTINCT sr.code ORDER BY sr.code),
      ARRAY[]::TEXT[]
    ) AS rbac_roles
  FROM org_users_mst oum
  LEFT JOIN org_auth_user_roles oaur ON oaur.user_id = oum.user_id
    AND oaur.tenant_org_id = oum.tenant_org_id
    AND oaur.is_active = true
  LEFT JOIN sys_auth_roles sr ON sr.role_id = oaur.role_id
  WHERE oum.is_active = true
    AND oum.role IN ('admin', 'operator', 'viewer')
  GROUP BY oum.user_id, oum.tenant_org_id, oum.role;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ CHECK_RBAC_MIGRATION_STATUS ] 
--=====================================
                        |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_USER_ROLE_COMPAT
-- Object Description : Get user role with backward compatibility (RBAC first, then old system)
-- Object ID : 19847
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_user_role_compat(p_user_id uuid, p_tenant_id uuid)
 RETURNS text
 LANGUAGE sql
 STABLE SECURITY DEFINER
AS $function$
  SELECT COALESCE(
    -- Try RBAC first
    (SELECT sr.code
     FROM org_auth_user_roles oaur
     JOIN sys_auth_roles sr ON sr.role_id = oaur.role_id
     WHERE oaur.user_id = p_user_id
       AND oaur.tenant_org_id = p_tenant_id
       AND oaur.is_active = true
     ORDER BY CASE sr.code
       WHEN 'tenant_admin' THEN 1
       WHEN 'operator' THEN 2
       WHEN 'viewer' THEN 3
       ELSE 4
     END
     LIMIT 1),
    -- Fallback to old system
    (SELECT role
     FROM org_users_mst
     WHERE user_id = p_user_id
       AND tenant_org_id = p_tenant_id
       AND is_active = true
     LIMIT 1)
  );
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ GET_USER_ROLE_COMPAT ] 
--=====================================
                               |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : MIGRATE_USERS_TO_RBAC_BATCH
-- Object Description : Migrate users to RBAC in batches
-- Object ID : 19848
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.migrate_users_to_rbac_batch(p_batch_size integer DEFAULT 100)
 RETURNS TABLE(batch_number integer, users_migrated integer, total_remaining integer)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  batch_num INTEGER := 1;
  migrated_count INTEGER;
  remaining_count INTEGER;
BEGIN
  LOOP
    -- Migrate one batch
    SELECT COUNT(*) INTO migrated_count
    FROM migrate_users_to_rbac();

    -- Check remaining users
    SELECT COUNT(*) INTO remaining_count
    FROM check_rbac_migration_status()
    WHERE has_rbac_role = false;

    -- Return batch result
    RETURN QUERY SELECT batch_num, migrated_count, remaining_count;

    -- Exit if no more users to migrate
    EXIT WHEN migrated_count = 0 OR remaining_count = 0;

    batch_num := batch_num + 1;

    -- Safety check: prevent infinite loops
    EXIT WHEN batch_num > 1000;
  END LOOP;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 
****** End Of Object Info ****** [ MIGRATE_USERS_TO_RBAC_BATCH ] 
--=====================================
                        |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CMX_REBUILD_USER_PERMISSIONS
-- Object Description : Rebuild effective permissions for a user-tenant combination (called on role/permission changes)
-- Object ID : 19789
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.cmx_rebuild_user_permissions(p_user_id uuid, p_tenant_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Clear old effective permissions for this user-tenant combination
  DELETE FROM cmx_effective_permissions
  WHERE user_id = p_user_id
    AND tenant_org_id = p_tenant_id;

  -- 1) Tenant-level roles  permissions (broadest scope)
  INSERT INTO cmx_effective_permissions (
    user_id, tenant_org_id, permission_code,
    resource_type, resource_id, allow
  )
  SELECT
    p_user_id,
    p_tenant_id,
    sp.code,
    NULL::TEXT,                    -- NULL = tenant-wide
    NULL::UUID,                    -- NULL = tenant-wide
    true
  FROM org_auth_user_roles our
  JOIN sys_auth_role_default_permissions srdp ON srdp.role_id = our.role_id
  JOIN sys_auth_permissions sp ON sp.permission_id = srdp.permission_id
  WHERE our.user_id = p_user_id
    AND our.tenant_org_id = p_tenant_id
    AND our.is_active = true
    AND sp.is_active = true;

  -- 2) Resource-level roles  permissions (resource-scoped)
  INSERT INTO cmx_effective_permissions (
    user_id, tenant_org_id, permission_code,
    resource_type, resource_id, allow
  )
  SELECT DISTINCT ON (p_user_id, p_tenant_id, sp.code, urr.resource_type, urr.resource_id)
    p_user_id,
    p_tenant_id,
    sp.code,
    urr.resource_type,
    urr.resource_id,
    true
  FROM org_auth_user_resource_roles urr
  JOIN sys_auth_role_default_permissions srdp ON srdp.role_id = urr.role_id
  JOIN sys_auth_permissions sp ON sp.permission_id = srdp.permission_id
  WHERE urr.user_id = p_user_id
    AND urr.tenant_org_id = p_tenant_id
    AND urr.is_active = true
    AND sp.is_active = true
  ORDER BY p_user_id, p_tenant_id, sp.code, urr.resource_type, urr.resource_id;

  -- 3) Global user permission overrides (tenant-wide overrides)
  -- Use UPDATE first, then INSERT for new ones
  UPDATE cmx_effective_permissions ep
  SET allow = oup.allow,
      created_at = NOW()
  FROM org_auth_user_permissions oup
  JOIN sys_auth_permissions sp ON sp.permission_id = oup.permission_id
  WHERE ep.user_id = p_user_id
    AND ep.tenant_org_id = p_tenant_id
    AND ep.permission_code = sp.code
    AND ep.resource_type IS NULL
    AND ep.resource_id IS NULL
    AND oup.user_id = p_user_id
    AND oup.tenant_org_id = p_tenant_id
    AND sp.is_active = true;

  INSERT INTO cmx_effective_permissions (
    user_id, tenant_org_id, permission_code,
    resource_type, resource_id, allow
  )
  SELECT
    p_user_id,
    p_tenant_id,
    sp.code,
    NULL::TEXT,
    NULL::UUID,
    oup.allow
  FROM org_auth_user_permissions oup
  JOIN sys_auth_permissions sp ON sp.permission_id = oup.permission_id
  WHERE oup.user_id = p_user_id
    AND oup.tenant_org_id = p_tenant_id
    AND sp.is_active = true
    AND NOT EXISTS (
      SELECT 1 FROM cmx_effective_permissions ep
      WHERE ep.user_id = p_user_id
        AND ep.tenant_org_id = p_tenant_id
        AND ep.permission_code = sp.code
        AND ep.resource_type IS NULL
        AND ep.resource_id IS NULL
    );

  -- 4) Resource-scoped permission overrides (most specific, wins)
  -- Use UPDATE first, then INSERT for new ones
  UPDATE cmx_effective_permissions ep
  SET allow = ourp.allow,
      created_at = NOW()
  FROM org_auth_user_resource_permissions ourp
  JOIN sys_auth_permissions sp ON sp.permission_id = ourp.permission_id
  WHERE ep.user_id = p_user_id
    AND ep.tenant_org_id = p_tenant_id
    AND ep.permission_code = sp.code
    AND ep.resource_type = ourp.resource_type
    AND ep.resource_id = ourp.resource_id
    AND ourp.user_id = p_user_id
    AND ourp.tenant_org_id = p_tenant_id
    AND sp.is_active = true;

  INSERT INTO cmx_effective_permissions (
    user_id, tenant_org_id, permission_code,
    resource_type, resource_id, allow
  )
  SELECT
    p_user_id,
    p_tenant_id,
    sp.code,
    ourp.resource_type,
    ourp.resource_id,
    ourp.allow
  FROM org_auth_user_resource_permissions ourp
  JOIN sys_auth_permissions sp ON sp.permission_id = ourp.permission_id
  WHERE ourp.user_id = p_user_id
    AND ourp.tenant_org_id = p_tenant_id
    AND sp.is_active = true
    AND NOT EXISTS (
      SELECT 1 FROM cmx_effective_permissions ep
      WHERE ep.user_id = p_user_id
        AND ep.tenant_org_id = p_tenant_id
        AND ep.permission_code = sp.code
        AND ep.resource_type = ourp.resource_type
        AND ep.resource_id = ourp.resource_id
    );
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 
****** End Of Object Info ****** [ CMX_REBUILD_USER_PERMISSIONS ] 
--=====================================
                       |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : MIGRATE_USERS_TO_RBAC
-- Object Description : Migrate existing users from org_users_mst.role to org_auth_user_roles
-- Object ID : 19845
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.migrate_users_to_rbac()
 RETURNS TABLE(user_id uuid, tenant_org_id uuid, old_role text, new_role_code text, migrated boolean)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  user_record RECORD;
  role_id_var UUID;
  migration_count INTEGER := 0;
BEGIN
  -- Loop through all users in org_users_mst
  FOR user_record IN
    SELECT DISTINCT
      oum.user_id,
      oum.tenant_org_id,
      oum.role AS old_role
    FROM org_users_mst oum
    WHERE oum.is_active = true
      AND oum.role IN ('admin', 'operator', 'viewer')
      -- Only migrate users that don't already have RBAC roles
      AND NOT EXISTS (
        SELECT 1
        FROM org_auth_user_roles oaur
        WHERE oaur.user_id = oum.user_id
          AND oaur.tenant_org_id = oum.tenant_org_id
      )
  LOOP
    -- Map old role to new role code
    -- admin -> tenant_admin
    -- operator -> operator
    -- viewer -> viewer
    CASE user_record.old_role
      WHEN 'admin' THEN
        SELECT role_id INTO role_id_var FROM sys_auth_roles WHERE code = 'tenant_admin';
      WHEN 'operator' THEN
        SELECT role_id INTO role_id_var FROM sys_auth_roles WHERE code = 'operator';
      WHEN 'viewer' THEN
        SELECT role_id INTO role_id_var FROM sys_auth_roles WHERE code = 'viewer';
      ELSE
        -- Skip unknown roles
        CONTINUE;
    END CASE;

    -- Insert into org_auth_user_roles
    -- Use explicit column references to avoid ambiguity
    INSERT INTO org_auth_user_roles (
      user_id,
      tenant_org_id,
      role_id,
      is_active,
      created_by
    )
    SELECT
      user_record.user_id,
      user_record.tenant_org_id,
      role_id_var,
      true,
      'system_migration'
    WHERE NOT EXISTS (
      SELECT 1
      FROM org_auth_user_roles oaur
      WHERE oaur.user_id = user_record.user_id
        AND oaur.tenant_org_id = user_record.tenant_org_id
        AND oaur.role_id = role_id_var
    );

    -- Rebuild effective permissions for this user
    PERFORM cmx_rebuild_user_permissions(user_record.user_id, user_record.tenant_org_id);

    migration_count := migration_count + 1;

    -- Return migration result
    RETURN QUERY SELECT
      user_record.user_id,
      user_record.tenant_org_id,
      user_record.old_role::TEXT,
      (CASE user_record.old_role
        WHEN 'admin' THEN 'tenant_admin'
        WHEN 'operator' THEN 'operator'
        WHEN 'viewer' THEN 'viewer'
        ELSE user_record.old_role::TEXT
      END)::TEXT,
      true;
  END LOOP;

  RAISE NOTICE 'Migrated % users to RBAC system', migration_count;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 
****** End Of Object Info ****** [ MIGRATE_USERS_TO_RBAC ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UPDATE_UPDATED_AT_COLUMN
-- Object Description : 
-- Object ID : 25976
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 
****** End Of Object Info ****** [ UPDATE_UPDATED_AT_COLUMN ] 
--=====================================
                           |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : HQ_USER_HAS_PERMISSION
-- Object Description : Check if HQ user has a specific permission based on their role
-- Object ID : 25983
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.hq_user_has_permission(p_user_id uuid, p_permission character varying)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
    v_permissions JSONB;
    v_permission_item TEXT;
BEGIN
    -- Get user's role permissions
    SELECT r.permissions INTO v_permissions
    FROM hq_users u
    JOIN hq_roles r ON u.role_code = r.role_code
    WHERE u.id = p_user_id AND u.is_active = true AND r.is_active = true;

    IF v_permissions IS NULL THEN
        RETURN false;
    END IF;

    -- Check for wildcard (super admin)
    IF v_permissions ? '*' THEN
        RETURN true;
    END IF;

    -- Check for exact permission
    IF v_permissions ? p_permission THEN
        RETURN true;
    END IF;

    -- Check for wildcard permissions (e.g., "tenants.*" matches "tenants.view")
    FOR v_permission_item IN SELECT jsonb_array_elements_text(v_permissions)
    LOOP
        IF v_permission_item LIKE '%.*' THEN
            IF p_permission LIKE REPLACE(v_permission_item, '.*', '.%') THEN
                RETURN true;
            END IF;
        END IF;
    END LOOP;

    RETURN false;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | 
****** End Of Object Info ****** [ HQ_USER_HAS_PERMISSION ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CREATE_TENANT_LIFECYCLE
-- Object Description : 
-- Object ID : 66216
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.create_tenant_lifecycle()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  INSERT INTO sys_tenant_lifecycle (
    tenant_org_id,
    lifecycle_stage,
    onboarding_status,
    onboarding_checklist,
    health_score,
    created_at
  ) VALUES (
    NEW.id,
    'trial',
    'not_started',
    jsonb_build_array(
      jsonb_build_object('step', 'setup_business_info', 'completed', false, 'required', true, 'order', 1),
      jsonb_build_object('step', 'configure_branding', 'completed', false, 'required', false, 'order', 2),
      jsonb_build_object('step', 'add_products', 'completed', false, 'required', true, 'order', 3),
      jsonb_build_object('step', 'invite_team', 'completed', false, 'required', false, 'order', 4),
      jsonb_build_object('step', 'create_first_order', 'completed', false, 'required', true, 'order', 5),
      jsonb_build_object('step', 'configure_workflows', 'completed', false, 'required', false, 'order', 6)
    ),
    0.0,
    CURRENT_TIMESTAMP
  )
  ON CONFLICT (tenant_org_id) DO NOTHING;

  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 
****** End Of Object Info ****** [ CREATE_TENANT_LIFECYCLE ] 
--=====================================
                            |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UPDATE_LIFECYCLE_TIMESTAMP
-- Object Description : 
-- Object ID : 66218
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.update_lifecycle_timestamp()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 
****** End Of Object Info ****** [ UPDATE_LIFECYCLE_TIMESTAMP ] 
--=====================================
                         |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : SYS_BILL_GENERATE_INVOICE_NUMBER
-- Object Description : 
-- Object ID : 75245
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.sys_bill_generate_invoice_number()
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
  next_num INTEGER;
  invoice_num VARCHAR;
BEGIN
  next_num := nextval('seq_invoice_number');
  invoice_num := 'INV-' || TO_CHAR(CURRENT_DATE, 'YYYY') || '-' || LPAD(next_num::TEXT, 6, '0');
  RETURN invoice_num;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ SYS_BILL_GENERATE_INVOICE_NUMBER ] 
--=====================================
                   |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : SYS_BILL_UPDATE_INVOICE_AMOUNT_DUE
-- Object Description : 
-- Object ID : 75246
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.sys_bill_update_invoice_amount_due()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.amount_due = NEW.total - NEW.amount_paid;

  -- Update status based on amount_due
  IF NEW.amount_due <= 0 THEN
    NEW.status = 'paid';
    NEW.paid_at = CURRENT_TIMESTAMP;
  ELSIF NEW.due_date < CURRENT_DATE AND NEW.amount_due > 0 THEN
    NEW.status = 'overdue';
  END IF;

  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 
****** End Of Object Info ****** [ SYS_BILL_UPDATE_INVOICE_AMOUNT_DUE ] 
--=====================================
                 |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : UPDATE_SUBSCRIPTION_UPDATED_AT
-- Object Description : 
-- Object ID : 75248
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.update_subscription_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ UPDATE_SUBSCRIPTION_UPDATED_AT ] 
--=====================================
                     |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : SYS_BILL_GET_DEFAULT_PAYMENT_METHOD
-- Object Description : 
-- Object ID : 75250
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.sys_bill_get_default_payment_method()
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN 'cash'; -- Cash is the primary/default payment method
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | 
****** End Of Object Info ****** [ SYS_BILL_GET_DEFAULT_PAYMENT_METHOD ] 
--=====================================
                |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : LOG_CODE_TABLE_CHANGE
-- Object Description : Logs a change to a code table with full audit trail information
-- Object ID : 91246
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.log_code_table_change(p_table_name character varying, p_record_code character varying, p_action character varying, p_old_values jsonb, p_new_values jsonb, p_changed_by uuid, p_change_reason text DEFAULT NULL::text, p_ip_address character varying DEFAULT NULL::character varying, p_user_agent text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_log_id UUID;
  v_changed_fields TEXT[];
BEGIN
  -- Calculate changed fields for UPDATE actions
  IF p_action = 'UPDATE' AND p_old_values IS NOT NULL AND p_new_values IS NOT NULL THEN
    SELECT ARRAY_AGG(key)
    INTO v_changed_fields
    FROM jsonb_each(p_new_values)
    WHERE p_old_values->>key IS DISTINCT FROM p_new_values->>key;
  END IF;

  -- Insert audit log entry
  INSERT INTO sys_code_table_audit_log (
    table_name,
    record_code,
    action,
    old_values,
    new_values,
    changed_fields,
    changed_by,
    changed_at,
    change_reason,
    ip_address,
    user_agent
  ) VALUES (
    p_table_name,
    p_record_code,
    p_action,
    p_old_values,
    p_new_values,
    v_changed_fields,
    p_changed_by,
    CURRENT_TIMESTAMP,
    p_change_reason,
    p_ip_address,
    p_user_agent
  )
  RETURNING id INTO v_log_id;

  RETURN v_log_id;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 
****** End Of Object Info ****** [ LOG_CODE_TABLE_CHANGE ] 
--=====================================
                              |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : GET_CODE_TABLE_HISTORY
-- Object Description : Retrieves change history for a specific code value, ordered by most recent
-- Object ID : 91247
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.get_code_table_history(p_table_name character varying, p_record_code character varying, p_limit integer DEFAULT 50)
 RETURNS TABLE(id uuid, action character varying, old_values jsonb, new_values jsonb, changed_fields text[], changed_by uuid, changed_at timestamp without time zone, change_reason text, is_rollback boolean)
 LANGUAGE plpgsql
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    l.id,
    l.action,
    l.old_values,
    l.new_values,
    l.changed_fields,
    l.changed_by,
    l.changed_at,
    l.change_reason,
    l.is_rollback
  FROM sys_code_table_audit_log l
  WHERE l.table_name = p_table_name
    AND l.record_code = p_record_code
  ORDER BY l.changed_at DESC
  LIMIT p_limit;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 
****** End Of Object Info ****** [ GET_CODE_TABLE_HISTORY ] 
--=====================================
                             |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : CHECK_CODE_TABLE_REFERENCES
-- Object Description : Checks if a code value is referenced in other tables (prevents orphaned references)
-- Object ID : 91248
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.check_code_table_references(p_table_name character varying, p_record_code character varying)
 RETURNS TABLE(referencing_table character varying, referencing_column character varying, reference_count bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- This is a placeholder that will be extended as we add more tables
  -- For now, it returns an empty result set
  -- TODO: Implement reference checking logic based on table_name

  RETURN QUERY
  SELECT
    ''::VARCHAR as referencing_table,
    ''::VARCHAR as referencing_column,
    0::BIGINT as reference_count
  WHERE false; -- Return empty set for now
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 
****** End Of Object Info ****** [ CHECK_CODE_TABLE_REFERENCES ] 
--=====================================
                        |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : INITIALIZE_TENANT_PRODUCT_CATALOG
-- Object Description : Initialize tenant product catalog from templates with configurable options
-- Object ID : 100211
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.initialize_tenant_product_catalog(p_tenant_org_id uuid, p_include_pricing boolean DEFAULT false, p_include_cost boolean DEFAULT false, p_create_default_price_list boolean DEFAULT false, p_seed_filter character varying DEFAULT 'standard'::character varying)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_products_created INTEGER := 0;
  v_price_list_id UUID;
  v_result JSONB;
BEGIN
  -- Copy templates to tenant products
  INSERT INTO org_product_data_mst (
    id,
    tenant_org_id,
    service_category_code,
    item_type_code,
    product_code,
    product_name,
    product_name2,
    hint_text,
    is_retail_item,
    product_type,
    price_type,
    product_unit,
    default_sell_price,
    default_express_sell_price,
    product_cost,
    min_sell_price,
    min_quantity,
    pieces_per_product,
    extra_days,
    turnaround_hh,
    turnaround_hh_express,
    multiplier_express,
    product_order,
    tags,
    id_sku,
    is_active,
    product_color1,
    product_color2,
    product_color3,
    product_icon,
    product_image,
    product_group1,
    product_group2,
    product_group3,
    rec_order,
    created_by,
    rec_status
  )
  SELECT
    gen_random_uuid(),
    p_tenant_org_id,
    service_category_code,
    item_type_code,
    template_code,  -- Use template_code as product_code
    name,
    name2,
    hint_text,
    is_retail_item,
    1,  -- Default product_type
    price_type,
    product_unit,
    CASE WHEN p_include_pricing THEN default_sell_price ELSE NULL END,
    CASE WHEN p_include_pricing THEN default_express_sell_price ELSE NULL END,
    CASE WHEN p_include_cost THEN product_cost ELSE NULL END,
    CASE WHEN p_include_pricing THEN min_sell_price ELSE NULL END,
    min_quantity,
    pieces_per_product,
    extra_days,
    turnaround_hh,
    turnaround_hh_express,
    multiplier_express,
    rec_order,
    tags,
    id_sku,
    true,  -- is_active
    product_color1,
    product_color2,
    product_color3,
    product_icon,
    product_image,
    item_type_code,  -- Map to product_group1 for backward compatibility
    NULL,
    NULL,
    seed_priority,
    'system_seed',
    1
  FROM sys_service_prod_templates_cd
  WHERE is_to_seed = true
    AND is_active = true
    AND (
      p_seed_filter = 'all'
      OR (
        seed_options IS NULL
        OR seed_options->>'required_for' IS NULL
        OR seed_options->>'required_for' ? p_seed_filter
      )
    )
  ORDER BY seed_priority ASC;

  GET DIAGNOSTICS v_products_created = ROW_COUNT;

  -- Optionally create default price list
  IF p_create_default_price_list AND p_include_pricing THEN
    INSERT INTO org_price_lists_mst (
      tenant_org_id,
      name,
      name2,
      description,
      price_list_type,
      is_default,
      is_active,
      created_by
    ) VALUES (
      p_tenant_org_id,
      'Standard Price List',
      '  ',
      'Default price list created during tenant initialization',
      'standard',
      true,
      true,
      'system_seed'
    )
    RETURNING id INTO v_price_list_id;

    -- Copy prices from products to price list
    INSERT INTO org_price_list_items_dtl (
      tenant_org_id,
      price_list_id,
      product_id,
      price,
      is_active,
      created_by
    )
    SELECT
      p_tenant_org_id,
      v_price_list_id,
      p.id,
      p.default_sell_price,
      true,
      'system_seed'
    FROM org_product_data_mst p
    WHERE p.tenant_org_id = p_tenant_org_id
      AND p.default_sell_price IS NOT NULL
      AND p.is_active = true;
  END IF;

  -- Build result
  v_result := jsonb_build_object(
    'success', true,
    'products_created', v_products_created,
    'price_list_created', p_create_default_price_list,
    'price_list_id', v_price_list_id,
    'tenant_org_id', p_tenant_org_id,
    'seed_filter', p_seed_filter,
    'include_pricing', p_include_pricing
  );

  RETURN v_result;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 
****** End Of Object Info ****** [ INITIALIZE_TENANT_PRODUCT_CATALOG ] 
--=====================================
                  |
| 
--===================================================
-- Object Type : FUNCTION
-- Object Name : RESEED_MISSING_PRODUCTS
-- Object Description : Restore missing or deleted products from templates for a specific tenant
-- Object ID : 100212
--===================================================
 Object Source Code IS : 
--===================================================
CREATE OR REPLACE FUNCTION public.reseed_missing_products(p_tenant_org_id uuid, p_include_pricing boolean DEFAULT false, p_only_missing boolean DEFAULT true, p_template_codes character varying[] DEFAULT NULL::character varying[])
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
  v_products_added INTEGER := 0;
  v_templates_found INTEGER := 0;
  v_already_exists INTEGER := 0;
  v_result JSONB;
  v_template RECORD;
BEGIN
  -- Get count of templates to process
  SELECT COUNT(*) INTO v_templates_found
  FROM sys_service_prod_templates_cd
  WHERE is_to_seed = true
    AND is_active = true
    AND (p_template_codes IS NULL OR template_code = ANY(p_template_codes));

  -- Process each template
  FOR v_template IN
    SELECT *
    FROM sys_service_prod_templates_cd
    WHERE is_to_seed = true
      AND is_active = true
      AND (p_template_codes IS NULL OR template_code = ANY(p_template_codes))
    ORDER BY seed_priority ASC
  LOOP
    -- Check if product already exists for this tenant
    IF EXISTS (
      SELECT 1 FROM org_product_data_mst
      WHERE tenant_org_id = p_tenant_org_id
        AND product_code = v_template.template_code
        AND (p_only_missing = false OR is_active = true)  -- Skip if only_missing and exists
    ) THEN
      v_already_exists := v_already_exists + 1;
      CONTINUE;  -- Skip this template
    END IF;

    -- Insert missing product
    INSERT INTO org_product_data_mst (
      id,
      tenant_org_id,
      service_category_code,
      item_type_code,
      product_code,
      product_name,
      product_name2,
      hint_text,
      is_retail_item,
      product_type,
      price_type,
      product_unit,
      default_sell_price,
      default_express_sell_price,
      product_cost,
      min_sell_price,
      min_quantity,
      pieces_per_product,
      extra_days,
      turnaround_hh,
      turnaround_hh_express,
      multiplier_express,
      product_order,
      tags,
      id_sku,
      is_active,
      product_color1,
      product_color2,
      product_color3,
      product_icon,
      product_image,
      product_group1,
      rec_order,
      created_by,
      rec_status
    ) VALUES (
      gen_random_uuid(),
      p_tenant_org_id,
      v_template.service_category_code,
      v_template.item_type_code,
      v_template.template_code,
      v_template.name,
      v_template.name2,
      v_template.hint_text,
      v_template.is_retail_item,
      1,
      v_template.price_type,
      v_template.product_unit,
      CASE WHEN p_include_pricing THEN v_template.default_sell_price ELSE NULL END,
      CASE WHEN p_include_pricing THEN v_template.default_express_sell_price ELSE NULL END,
      NULL,  -- Don't include cost on reseed
      CASE WHEN p_include_pricing THEN v_template.min_sell_price ELSE NULL END,
      v_template.min_quantity,
      v_template.pieces_per_product,
      v_template.extra_days,
      v_template.turnaround_hh,
      v_template.turnaround_hh_express,
      v_template.multiplier_express,
      v_template.rec_order,
      v_template.tags,
      v_template.id_sku,
      true,
      v_template.product_color1,
      v_template.product_color2,
      v_template.product_color3,
      v_template.product_icon,
      v_template.product_image,
      v_template.item_type_code,
      v_template.seed_priority,
      'system_reseed',
      1
    );

    v_products_added := v_products_added + 1;
  END LOOP;

  -- Build result
  v_result := jsonb_build_object(
    'success', true,
    'templates_found', v_templates_found,
    'products_added', v_products_added,
    'already_exists', v_already_exists,
    'tenant_org_id', p_tenant_org_id
  );

  RETURN v_result;
END;
$function$

--===================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | 
****** End Of Object Info ****** [ RESEED_MISSING_PRODUCTS ] 
--=====================================
                            |