PRD-005: Basic Workflow & Status Transitions - COMPLETE Implementation Plan
üìã Overview
Implement full 14-stage configurable workflow system with quality gates, audit trails, bulk operations, and SLA tracking. Current Status: 15% complete (UI scaffolding only) Effort: 40 hours (1 week with 2 developers) Dependencies: ‚úÖ PRD-001 (Auth), ‚úÖ PRD-004 (Order Intake)
üéØ Critical Requirements from Additional Requirements File
Complete 14-Stage Workflow:
DRAFT ‚Üí INTAKE ‚Üí PREPARATION ‚Üí SORTING ‚Üí WASHING ‚Üí DRYING ‚Üí 
FINISHING ‚Üí ASSEMBLY ‚Üí QA ‚Üí PACKING ‚Üí READY ‚Üí OUT_FOR_DELIVERY ‚Üí 
DELIVERED ‚Üí CLOSED
Configurable Workflows by:
Tenant Features (from subscription plan)
useIntake, useAssembly, useQualityCheck, useDelivery, useSorting
Service Category
Dry Cleaning: Full workflow
Laundry: Full workflow
Pressed/Ironed: Start from FINISHING (skip wash/dry)
Repairs: intake ‚Üí repair ‚Üí QA ‚Üí ready
Alterations: intake ‚Üí alteration ‚Üí QA ‚Üí ready
Quality Gates (CRITICAL - Orders CANNOT progress to READY without):
‚úÖ All items assembled
‚úÖ QA passed
‚úÖ No unresolved issues
üì¶ Phase 1: Database Foundation (6 hours)
Migration: 0013_workflow_status_system.sql
New Tables:
org_order_status_history - Audit trail
CREATE TABLE org_order_status_history (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  order_id          UUID NOT NULL REFERENCES org_orders_mst(id) ON DELETE CASCADE,
  tenant_org_id     UUID NOT NULL REFERENCES org_tenants_mst(id) ON DELETE CASCADE,
  from_status       VARCHAR(50),
  to_status         VARCHAR(50) NOT NULL,
  changed_by        UUID REFERENCES auth.users(id),
  changed_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  notes             TEXT,
  metadata          JSONB DEFAULT '{}'::jsonb,
  -- Audit fields
  created_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Composite FK for tenant isolation
ALTER TABLE org_order_status_history
  ADD CONSTRAINT fk_status_history_order
  FOREIGN KEY (order_id, tenant_org_id) 
  REFERENCES org_orders_mst(id, tenant_org_id) ON DELETE CASCADE;

-- Indexes
CREATE INDEX idx_status_history_order ON org_order_status_history(order_id, changed_at DESC);
CREATE INDEX idx_status_history_tenant ON org_order_status_history(tenant_org_id, changed_at DESC);
CREATE INDEX idx_status_history_user ON org_order_status_history(changed_by);

-- RLS
ALTER TABLE org_order_status_history ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON org_order_status_history
  FOR ALL USING (tenant_org_id = auth.jwt() ->> 'tenant_org_id'::text);
org_workflow_settings_cf - Configurable workflow rules
CREATE TABLE org_workflow_settings_cf (
  id                     UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_org_id          UUID NOT NULL REFERENCES org_tenants_mst(id) ON DELETE CASCADE,
  service_category_code  VARCHAR(120),
  workflow_steps         JSONB NOT NULL DEFAULT '["INTAKE","PREPARATION","WASHING","DRYING","FINISHING","ASSEMBLY","QA","PACKING","READY","OUT_FOR_DELIVERY","DELIVERED","CLOSED"]'::jsonb,
  status_transitions     JSONB NOT NULL DEFAULT '{}'::jsonb,
  quality_gate_rules     JSONB DEFAULT '{}'::jsonb,
  is_active              BOOLEAN DEFAULT true,
  created_at             TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at             TIMESTAMP,
  created_by             UUID,
  UNIQUE(tenant_org_id, service_category_code)
);

-- Composite FK
ALTER TABLE org_workflow_settings_cf
  ADD CONSTRAINT fk_workflow_settings_category
  FOREIGN KEY (tenant_org_id, service_category_code) 
  REFERENCES org_service_category_cf(tenant_org_id, service_category_code);

-- Indexes
CREATE INDEX idx_workflow_settings_tenant ON org_workflow_settings_cf(tenant_org_id);
CREATE INDEX idx_workflow_settings_category ON org_workflow_settings_cf(tenant_org_id, service_category_code);

-- RLS
ALTER TABLE org_workflow_settings_cf ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON org_workflow_settings_cf
  FOR ALL USING (tenant_org_id = auth.jwt() ->> 'tenant_org_id'::text);
org_workflow_rules - Allowed transitions
CREATE TABLE org_workflow_rules (
  id                UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_org_id     UUID NOT NULL REFERENCES org_tenants_mst(id) ON DELETE CASCADE,
  from_status       VARCHAR(50) NOT NULL,
  to_status         VARCHAR(50) NOT NULL,
  is_allowed        BOOLEAN DEFAULT true,
  requires_role     VARCHAR(50),
  validation_rules  JSONB DEFAULT '{}'::jsonb,
  created_at        TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(tenant_org_id, from_status, to_status)
);

-- Indexes
CREATE INDEX idx_workflow_rules_tenant ON org_workflow_rules(tenant_org_id);
CREATE INDEX idx_workflow_rules_transition ON org_workflow_rules(tenant_org_id, from_status, to_status);

-- RLS
ALTER TABLE org_workflow_rules ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON org_workflow_rules
  FOR ALL USING (tenant_org_id = auth.jwt() ->> 'tenant_org_id'::text);
Seed Default Workflow Rules:
-- Insert default workflow for all existing tenants
INSERT INTO org_workflow_settings_cf (tenant_org_id, service_category_code, workflow_steps, status_transitions)
SELECT 
  t.id as tenant_org_id,
  NULL as service_category_code,
  '["DRAFT","INTAKE","PREPARATION","SORTING","WASHING","DRYING","FINISHING","ASSEMBLY","QA","PACKING","READY","OUT_FOR_DELIVERY","DELIVERED","CLOSED"]'::jsonb,
  '{
    "DRAFT": ["INTAKE","CANCELLED"],
    "INTAKE": ["PREPARATION","CANCELLED"],
    "PREPARATION": ["SORTING","CANCELLED"],
    "SORTING": ["WASHING","FINISHING","CANCELLED"],
    "WASHING": ["DRYING","CANCELLED"],
    "DRYING": ["FINISHING","CANCELLED"],
    "FINISHING": ["ASSEMBLY","PACKING","CANCELLED"],
    "ASSEMBLY": ["QA","CANCELLED"],
    "QA": ["PACKING","WASHING","CANCELLED"],
    "PACKING": ["READY","CANCELLED"],
    "READY": ["OUT_FOR_DELIVERY","DELIVERED","CANCELLED"],
    "OUT_FOR_DELIVERY": ["DELIVERED","READY","CANCELLED"],
    "DELIVERED": ["CLOSED"],
    "CLOSED": []
  }'::jsonb
FROM org_tenants_mst t;
Update Prisma:
cd web-admin
npx prisma db pull
npx prisma generate
‚öôÔ∏è Phase 2: Backend Services (14 hours)
File: web-admin/lib/services/workflow-service.ts
Core WorkflowService class with methods:
export class WorkflowService {
  // Status transition with validation
  async changeStatus(params: ChangeStatusParams): Promise<ChangeStatusResult>
  
  // Check if transition is allowed
  async isTransitionAllowed(params: TransitionCheckParams): Promise<boolean>
  
  // Get workflow for tenant/service
  async getWorkflowForTenant(tenantId: string, serviceCategoryCode?: string): Promise<string[]>
  
  // Quality gate validation for READY status
  async canMoveToReady(orderId: string): Promise<QualityGateResult>
  
  // Bulk status update with transaction
  async bulkChangeStatus(params: BulkChangeParams): Promise<BulkChangeResult>
  
  // Get status history
  async getStatusHistory(orderId: string): Promise<StatusHistoryEntry[]>
  
  // Find overdue orders
  async getOverdueOrders(tenantId: string): Promise<OverdueOrder[]>
  
  // Auto-transition logic
  async checkAutoTransitions(orderId: string): Promise<void>
}
Key Logic: Quality Gate Validation
async canMoveToReady(orderId: string): Promise<QualityGateResult> {
  const order = await getOrderWithItems(orderId);
  const blockers: string[] = [];
  
  // Check 1: All items assembled
  const unassembled = order.items.filter(item => 
    item.status !== 'ASSEMBLED' && item.status !== 'QA_PASSED'
  );
  if (unassembled.length > 0) {
    blockers.push(`${unassembled.length} items not assembled`);
  }
  
  // Check 2: QA completed
  const failedQA = order.items.filter(item => 
    item.qa_status === 'FAILED' || !item.qa_status
  );
  if (failedQA.length > 0) {
    blockers.push(`${failedQA.length} items failed QA`);
  }
  
  // Check 3: Pending issues
  const pendingIssues = order.items.filter(item => 
    item.issues?.length > 0 && !item.issues_resolved
  );
  if (pendingIssues.length > 0) {
    blockers.push(`${pendingIssues.length} items have unresolved issues`);
  }
  
  return {
    canMove: blockers.length === 0,
    blockers
  };
}
API Routes:
web-admin/app/api/orders/[orderId]/status/route.ts
PATCH: Update single order status
Validates transition, records audit trail
Returns updated order with status
web-admin/app/api/orders/bulk-status/route.ts
POST: Bulk update order statuses
Transaction support for consistency
Returns success/failure counts
web-admin/app/api/orders/[orderId]/status-history/route.ts
GET: Fetch complete audit trail
Includes user info, timestamps, notes
web-admin/app/api/orders/overdue/route.ts
GET: List orders past ready_by date
Calculates hours overdue
Filterable by branch/status
web-admin/app/api/dashboard/workflow-stats/route.ts
GET: Workflow statistics for dashboard
Status distribution, avg time per stage
SLA compliance percentage
üé® Phase 3: Frontend Components (16 hours)
1. Update: web-admin/app/dashboard/orders/components/order-actions.tsx
Replace placeholder with real implementation:
Connect to PATCH /api/orders/[orderId]/status
Add confirmation modal with notes field
Show loading states
Display success/error toasts
Disable invalid transitions (grayed out)
Show quality gate blockers if transition to READY fails
2. Enhance: web-admin/app/dashboard/orders/components/order-timeline.tsx
Add full audit trail:
Fetch from /api/orders/[orderId]/status-history
Display user avatars and names
Show timestamp for each change
Expandable notes section
Color-coded by status type
Auto-refresh every 30 seconds
3. New: web-admin/app/dashboard/orders/components/bulk-status-update.tsx
Bulk operations component:
Checkbox selection in order list
Floating action bar when items selected
Status dropdown showing only valid transitions
Confirmation modal with order count
Progress indicator during update
Summary of success/failures
4. New: web-admin/app/dashboard/orders/components/order-status-badge.tsx
Reusable status badge:
Color-coded by status
Icons for each status
Bilingual (EN/AR)
Tooltip with status description
5. New: web-admin/app/dashboard/components/overdue-orders-widget.tsx
Dashboard widget:
Red badge with overdue count
Compact table with order number, customer, hours late
Click to navigate to order detail
Refresh button
6. New: web-admin/app/dashboard/components/workflow-stats-widget.tsx
Dashboard statistics:
Donut chart showing status distribution
Average time per stage
SLA compliance percentage
Trend indicators
üß™ Phase 4: Testing (6 hours)
Unit Tests:
workflow-service.test.ts
Status transition validation
Quality gate logic
Workflow customization by tenant/service
Bulk update transaction handling
status-api.test.ts
API endpoint responses
Error handling
Multi-tenant isolation
Integration Tests:
workflow-integration.test.ts
Complete order lifecycle (DRAFT ‚Üí CLOSED)
Quality gate blocking (ASSEMBLY ‚Üí READY fails if QA incomplete)
Auto-transitions
Audit trail creation
bulk-operations.test.ts
Bulk update 50+ orders
Partial failure handling
Transaction rollback
E2E Tests:
order-workflow.spec.ts (Playwright)
Staff changes order status via UI
Status timeline updates in real-time
Bulk status update flow
Arabic RTL interface
Performance Tests:
workflow-performance.test.ts
Status update < 200ms
10,000 concurrent queries
Audit trail queries with pagination
üìö Phase 5: Documentation (2 hours)
Create Feature Documentation Structure:
docs/features/005_basic_workflow/
‚îú‚îÄ‚îÄ README.md - Overview and purpose
‚îú‚îÄ‚îÄ development_plan.md - Implementation roadmap
‚îú‚îÄ‚îÄ progress_summary.md - Completed work log
‚îú‚îÄ‚îÄ current_status.md - Current implementation state
‚îú‚îÄ‚îÄ user_guide.md - Staff workflows and screenshots
‚îú‚îÄ‚îÄ testing_scenarios.md - Test cases and coverage
‚îú‚îÄ‚îÄ CHANGELOG.md - Version history
‚îú‚îÄ‚îÄ version.txt - v1.0.0
‚îî‚îÄ‚îÄ technical_docs/
    ‚îú‚îÄ‚îÄ api_specs.md - API endpoint documentation
    ‚îú‚îÄ‚îÄ workflow_rules.md - Transition rules and logic
    ‚îî‚îÄ‚îÄ quality_gates.md - Quality gate specifications
Update Root Documentation:
docs/folders_lookup.md - Add 005_basic_workflow entry
docs/plan/master_plan_cc_01.md - Mark PRD-005 as complete
‚úÖ Acceptance Criteria
Functional:
 Single order status updates with validation
 Bulk status update handles 50+ orders in transaction
 All status changes create audit trail entries
 Status history displays with user info and notes
 Quality gates block READY transition correctly
 Overdue orders identified and displayed
 Dashboard shows accurate workflow statistics
 Configurable workflows by tenant/service category
 Auto-transition from PREPARATION ‚Üí PROCESSING works
Non-Functional:
 Status update response time < 200ms
 Supports 10,000+ concurrent status queries
 Audit trail retention: 2 years (database policy)
 Multi-tenant isolation verified in tests
 Bilingual UI (EN/AR) with RTL support
Quality:
 80%+ test coverage
 All tests passing
 No TypeScript errors
 Passes code review checklist
 Documentation complete and accurate
üìä Implementation Summary
New Files (13):
supabase/migrations/0013_workflow_status_system.sql
web-admin/lib/services/workflow-service.ts
web-admin/app/api/orders/[orderId]/status/route.ts
web-admin/app/api/orders/bulk-status/route.ts
web-admin/app/api/orders/[orderId]/status-history/route.ts
web-admin/app/api/orders/overdue/route.ts
web-admin/app/api/dashboard/workflow-stats/route.ts
web-admin/app/dashboard/orders/components/bulk-status-update.tsx
web-admin/app/dashboard/orders/components/order-status-badge.tsx
web-admin/app/dashboard/components/overdue-orders-widget.tsx
web-admin/app/dashboard/components/workflow-stats-widget.tsx
web-admin/lib/types/workflow.ts (TypeScript interfaces)
Documentation folder with 8+ files
Modified Files (3):
web-admin/app/dashboard/orders/components/order-actions.tsx
web-admin/app/dashboard/orders/components/order-timeline.tsx
web-admin/app/dashboard/orders/page.tsx (add bulk selection)
Database Changes:
3 new tables: org_order_status_history, org_workflow_settings_cf, org_workflow_rules
9 new indexes for performance
3 RLS policies for security
Seed data for default workflows
Effort Breakdown:
Database: 6 hours (new tables + seed data)
Backend: 14 hours (services + 5 API routes)
Frontend: 16 hours (2 enhanced + 4 new components)
Testing: 6 hours (unit + integration + E2E)
Documentation: 2 hours
Total: 44 hours (1 week with 2 developers working in parallel)
üöÄ Deployment Notes
Backward Compatible: Yes
New tables don't affect existing functionality
Existing orders continue to work with TEXT status field
Migration adds audit trail retroactively (history starts now)
Rollback Plan:
Drop new tables if issues occur
Existing orders unaffected
Post-Deployment:
Verify workflow settings seeded for all tenants
Test status transitions on production data
Monitor API response times
Check audit trail creation
üîó Dependencies & Related PRDs
Dependencies: ‚úÖ Complete
PRD-001 (Authentication & Authorization)
PRD-004 (Order Intake)
Future PRDs Using This:
PRD-007 (Admin Dashboard) - Uses workflow stats
PRD-009 (Assembly & QA) - Advanced workflow features
PRD-019 (Notifications) - Email/SMS on status change
PRD-023 (Delivery Management) - Driver app integration
