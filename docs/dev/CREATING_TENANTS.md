# Creating New Tenants Guide

**Quick Reference for Creating Multi-Tenant Organizations**

---

## Quick Start

### Method 1: Via SQL (Simplest)

```sql
INSERT INTO org_tenants_mst (
  name,
  slug,
  email,
  phone
)
VALUES (
  'Your Business Name',
  'your-business-slug',
  'contact@your-business.com',
  '+96899999999'
)
RETURNING id;
```

**That's it!** The system automatically creates:
- ✅ Subscription (14-day free trial)
- ✅ Main branch
- ✅ All service categories enabled

---

## Detailed Guide

### Step 1: Prepare Tenant Information

Gather the following information:

**Required:**
- Business name (English)
- Unique slug (URL-friendly identifier)
- Contact email
- Contact phone

**Optional:**
- Business name (Arabic)
- Full address
- City
- Country (default: OM)
- Currency (default: OMR)
- Timezone (default: Asia/Muscat)
- Language (default: en)

### Step 2: Create Tenant Record

```sql
INSERT INTO org_tenants_mst (
  -- Required fields
  name,
  name2,
  slug,
  email,
  phone,

  -- Optional fields
  address,
  city,
  country,
  currency,
  timezone,
  language,

  -- System fields (auto-set)
  s_cureent_plan,  -- 'plan_freemium'
  is_active,       -- true
  status,          -- 'trial'
  created_at,      -- NOW()
  updated_at       -- NOW()
)
VALUES (
  -- Required
  'Premium Laundry Services',
  'خدمات غسيل بريميوم',
  'premium-laundry',
  'contact@premium-laundry.om',
  '+96824567890',

  -- Optional
  'Building 42, Way 123, Al Khuwair',
  'Muscat',
  'OM',
  'OMR',
  'Asia/Muscat',
  'ar',

  -- System fields (can omit, will use defaults)
  DEFAULT,
  DEFAULT,
  DEFAULT,
  DEFAULT,
  DEFAULT
)
RETURNING id, name, slug, status;
```

### Step 3: Verify Initialization

```sql
-- Check what was created
SELECT
  t.id as tenant_id,
  t.name as tenant_name,
  t.status,
  s.plan as subscription_plan,
  s.trial_ends,
  s.orders_limit,
  b.id as branch_id,
  b.branch_name,
  (SELECT COUNT(*) FROM org_service_category_cf WHERE tenant_org_id = t.id) as services_enabled
FROM org_tenants_mst t
LEFT JOIN org_subscriptions_mst s ON s.tenant_org_id = t.id
LEFT JOIN org_branches_mst b ON b.tenant_org_id = t.id
WHERE t.id = '<tenant_id_from_step_2>';
```

Expected result:
```
tenant_id    | <your-uuid>
tenant_name  | Premium Laundry Services
status       | trial
plan         | free
trial_ends   | <14 days from now>
orders_limit | 50
branch_id    | <auto-generated-uuid>
branch_name  | Main Branch
services_enabled | 3 (or more)
```

### Step 4: Create Admin User

**Option A: Via Script (Development)**

```bash
cd web-admin
node ../scripts/create-test-user.js
```

Edit script to use your tenant ID and credentials.

**Option B: Via SQL Function**

```sql
SELECT create_and_link_auth_user(
  'owner@premium-laundry.om',  -- Admin email
  'SecurePassword123',          -- Admin password
  '<tenant_id>',                -- From step 2
  'Business Owner'              -- Display name
);
```

**Option C: Via Supabase Studio**

1. Open http://127.0.0.1:54323
2. Navigate to **Authentication** > **Users**
3. Click **Add User**
4. Enter:
   - Email: owner@premium-laundry.om
   - Password: SecurePassword123
   - Email Confirm: ✅ (for development)
5. Copy the created user ID
6. Run:
   ```sql
   SELECT create_tenant_admin(
     '<user_id_from_step_5>',
     '<tenant_id>',
     'Business Owner'
   );
   ```

### Step 5: Test Login

1. Navigate to http://localhost:3000/login
2. Enter admin credentials
3. Verify redirect to dashboard
4. Check tenant name appears correctly

---

## Advanced: Full Custom Setup

### Manual Initialization (Skip Auto-Trigger)

If you need complete control over initialization:

```sql
-- Step 1: Create tenant (trigger fires but can be managed)
INSERT INTO org_tenants_mst (id, name, slug, email, phone)
VALUES (
  '12345678-1234-1234-1234-123456789012',
  'Custom Tenant',
  'custom-tenant',
  'custom@example.com',
  '+96800000000'
);

-- Step 2: Create custom subscription
INSERT INTO org_subscriptions_mst (
  tenant_org_id,
  plan,
  status,
  orders_limit,
  orders_used,
  branch_limit,
  user_limit,
  start_date,
  end_date
)
VALUES (
  '12345678-1234-1234-1234-123456789012',
  'pro',           -- Custom plan
  'active',        -- Active status
  10000,           -- High order limit
  0,
  10,              -- Multiple branches
  50,              -- Many users
  NOW(),
  NOW() + INTERVAL '1 year'
);

-- Step 3: Create multiple branches
INSERT INTO org_branches_mst (tenant_org_id, branch_name, city)
VALUES
  ('12345678-1234-1234-1234-123456789012', 'Main Branch', 'Muscat'),
  ('12345678-1234-1234-1234-123456789012', 'Salalah Branch', 'Salalah'),
  ('12345678-1234-1234-1234-123456789012', 'Sohar Branch', 'Sohar');

-- Step 4: Enable specific service categories
INSERT INTO org_service_category_cf (tenant_org_id, service_category_code)
VALUES
  ('12345678-1234-1234-1234-123456789012', 'WASH_AND_IRON'),
  ('12345678-1234-1234-1234-123456789012', 'DRY_CLEAN');
  -- Excluding IRON_ONLY intentionally
```

---

## Common Scenarios

### Scenario 1: Create Demo Tenant for Testing

```sql
INSERT INTO org_tenants_mst (
  id,
  name,
  slug,
  email,
  phone,
  status
)
VALUES (
  gen_random_uuid(),
  'Demo ' || to_char(NOW(), 'YYYYMMDD-HH24MI'),
  'demo-' || substr(md5(random()::text), 1, 8),
  'demo-' || substr(md5(random()::text), 1, 8) || '@cleanmatex.dev',
  '+96800000000',
  'trial'
)
RETURNING id, name, slug;
```

### Scenario 2: Create Production Tenant with Premium Plan

```sql
BEGIN;

-- Create tenant
INSERT INTO org_tenants_mst (name, slug, email, phone, status)
VALUES (
  'Enterprise Laundry Co',
  'enterprise-laundry',
  'admin@enterprise-laundry.com',
  '+96812345678',
  'active'  -- Active immediately
)
RETURNING id INTO @tenant_id;

-- Update subscription to premium
UPDATE org_subscriptions_mst
SET
  plan = 'pro',
  status = 'active',
  orders_limit = 50000,
  branch_limit = 100,
  user_limit = 500,
  end_date = NOW() + INTERVAL '1 year'
WHERE tenant_org_id = @tenant_id;

COMMIT;
```

### Scenario 3: Migrate Existing Business

```sql
-- Create tenant with historical data
INSERT INTO org_tenants_mst (
  id,  -- Use specific UUID if migrating
  name,
  slug,
  email,
  phone,
  created_at  -- Preserve original creation date
)
VALUES (
  'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
  'Established Laundry 2010',
  'established-laundry',
  'info@established-laundry.om',
  '+96899887766',
  '2010-01-15 10:00:00'  -- Historical date
);

-- Then manually create subscription with appropriate plan
-- and import historical orders, customers, etc.
```

---

## Bulk Tenant Creation

For creating multiple tenants (e.g., onboarding event):

```sql
-- Create multiple tenants from CSV/staging table
INSERT INTO org_tenants_mst (name, slug, email, phone, city)
SELECT
  business_name,
  lower(regexp_replace(business_name, '[^a-zA-Z0-9]+', '-', 'g')),
  contact_email,
  contact_phone,
  business_city
FROM staging_tenant_imports
WHERE imported = false;

-- Mark as imported
UPDATE staging_tenant_imports
SET imported = true,
    imported_at = NOW()
WHERE imported = false;
```

---

## Validation Checklist

Before going live with a new tenant:

- [ ] Tenant record created with unique slug
- [ ] Email and phone are valid and contactable
- [ ] Subscription exists with correct plan and limits
- [ ] At least one branch created
- [ ] Service categories enabled
- [ ] At least one admin user created
- [ ] Admin user can login successfully
- [ ] Tenant appears in admin dashboard
- [ ] RLS policies working (tenant isolation)
- [ ] Sample order can be created
- [ ] Email notifications configured (if applicable)

SQL Check:
```sql
SELECT
  t.name,
  t.email,
  t.phone,
  t.status,
  s.plan,
  s.orders_limit,
  (SELECT COUNT(*) FROM org_branches_mst WHERE tenant_org_id = t.id) as branches,
  (SELECT COUNT(*) FROM org_users_mst WHERE tenant_org_id = t.id) as users,
  (SELECT COUNT(*) FROM org_service_category_cf WHERE tenant_org_id = t.id) as services
FROM org_tenants_mst t
JOIN org_subscriptions_mst s ON s.tenant_org_id = t.id
WHERE t.id = '<tenant_id>';
```

---

## Troubleshooting

### Problem: Slug Already Exists

```
ERROR: duplicate key value violates unique constraint "org_tenants_mst_slug_key"
```

**Solution:**
```sql
-- Check existing slugs
SELECT slug FROM org_tenants_mst WHERE slug LIKE 'your-business%';

-- Use modified slug
slug = 'your-business-2' or 'your-business-muscat'
```

### Problem: Email Already Exists

```
ERROR: duplicate key value violates unique constraint "org_tenants_mst_email_key"
```

**Solution:** Each tenant must have a unique contact email. Use:
- Different email address
- Email alias: info+tenant1@domain.com, info+tenant2@domain.com
- Subdomain: tenant1@support.domain.com

### Problem: Auto-Initialization Didn't Run

**Check:**
```sql
-- Verify trigger exists and is enabled
SELECT * FROM pg_trigger WHERE tgname = 'trg_after_tenant_insert';

-- Check tenant initialization status
SELECT * FROM sys_audit_log
WHERE action = 'tenant_initialized'
AND tenant_org_id = '<tenant_id>';
```

**Fix:**
```sql
-- Manually initialize
SELECT initialize_new_tenant('<tenant_id>');
```

---

## Security Considerations

### Never Do This

```sql
-- ❌ DON'T: Create tenant with insecure status
status = 'active' without proper verification

-- ❌ DON'T: Skip email verification in production
-- ❌ DON'T: Use weak admin passwords
-- ❌ DON'T: Share tenant credentials
-- ❌ DON'T: Create admin users without proper authentication
```

### Always Do This

```sql
-- ✅ DO: Use strong, unique passwords
-- ✅ DO: Verify email ownership before activation
-- ✅ DO: Set appropriate trial periods
-- ✅ DO: Log all tenant creation events
-- ✅ DO: Test tenant isolation immediately
```

---

## Next Steps After Creation

1. **Configure Tenant Settings**
   - Upload logo/branding
   - Set business hours
   - Configure notification preferences
   - Set up payment methods

2. **Add Additional Users**
   - Invite staff members
   - Assign roles (admin, operator, viewer)
   - Set permissions

3. **Import Data** (if applicable)
   - Customer list
   - Service prices
   - Historical orders

4. **Test Workflows**
   - Create test order
   - Process through workflow
   - Verify notifications
   - Test customer portal

---

## See Also

- [Tenant Initialization System](./TENANT_INITIALIZATION.md)
- [Test Credentials](./TEST_CREDENTIALS.md)
- [Multi-Tenancy Rules](../../.claude/docs/multitenancy.md)
- [Subscription Management](../../.claude/docs/subscription_limits.md)

---

**Last Updated:** 2025-10-23
**Maintainer:** CleanMateX Development Team
