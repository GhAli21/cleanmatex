> Combined from `@.claude/docs/architecture.md` and `@.claude/docs/02-architecture.md` on 2025-10-17

# System Architecture

## Dual-Layer Data Model

```
SYSTEM LAYER (sys_*): Global shared data, no tenant_id
ORGANIZATION LAYER (org_*): Tenant data with RLS
```
Core entities use composite keys like `(tenant_org_id, entity_id)` to enforce isolation at schema level. RLS provides runtime isolation.

## Stack
- **DB:** PostgreSQL 16 (Supabase Local on port 54322), JSONB, composite PKs, RLS, planned partitioning
- **ORM:** Prisma (server-side library, NOT a service) + Supabase Client (client-side) - Hybrid approach
- **Web Admin:** Next.js 15, React 19, TS 5, Tailwind v4, React Query + Zustand, next-intl
- **Mobile (planned):** Flutter apps for customer, driver, store; Riverpod, Dio, Hive
- **Backend (planned):** NestJS with Prisma, Redis, BullMQ
- **Infra:** Supabase Local (includes Postgres on port 54322), Docker Compose for Redis & MinIO only

**Note:** We do NOT use a separate Docker Postgres container. Supabase Local includes PostgreSQL.

## Data Access Layer - Hybrid Strategy

### Dual ORM Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Supabase PostgreSQL Database         â”‚
â”‚         (RLS Policies Active)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase JS    â”‚  â”‚  Prisma Client     â”‚
â”‚  Client         â”‚  â”‚  (Direct PG)       â”‚
â”‚  (PostgREST)    â”‚  â”‚  + Middleware      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client-Side    â”‚  â”‚  Server-Side       â”‚
â”‚  - React        â”‚  â”‚  - API Routes      â”‚
â”‚  - Auth         â”‚  â”‚  - Server Actions  â”‚
â”‚  - Real-time    â”‚  â”‚  - Business Logic  â”‚
â”‚  - Storage      â”‚  â”‚  - Complex Queries â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### When to Use Each Tool

| Use Case | Tool | Location | Why |
|----------|------|----------|-----|
| Client-side queries | Supabase JS | React Components | RLS enforcement, real-time |
| Server API routes | Prisma | API Routes/Actions | Type safety, middleware |
| Authentication | Supabase Auth | Both | Built-in, JWT tokens |
| File uploads | Supabase Storage | Both | S3-compatible |
| Real-time subs | Supabase Realtime | Client | WebSocket support |
| Complex joins | Prisma | Server | Better query builder |
| Business logic | Prisma | Server | Transactions, middleware |
| Reporting | Prisma | Server | Aggregations, raw SQL |

### Multi-Tenancy Enforcement

**Application Layer (Prisma Middleware):**
- Auto-inject `tenant_org_id` filter on all `org_*` tables
- Enforced via middleware in `lib/prisma-middleware.ts`
- Compile-time type checking prevents mistakes

**Database Layer (RLS Policies):**
- Existing RLS policies still active
- Defense-in-depth security model
- Works even if application layer bypassed

**Example - Automatic Tenant Filtering:**
```typescript
// Middleware auto-adds: WHERE tenant_org_id = {session.tenant_org_id}
const orders = await prisma.org_orders_mst.findMany({
  include: {
    customer: true,
    items: true,
  }
})
// âœ… tenant_org_id filter added automatically by middleware
```

### Type Safety Benefits

**Before (Raw Supabase):**
```typescript
const { data } = await supabase
  .from('org_orders_mst')
  .select('*')
  .eq('tenant_org_id', tenantId) // Easy to forget!
// data is loosely typed
```

**After (Prisma):**
```typescript
const orders = await prisma.org_orders_mst.findMany()
// âœ… Fully typed return value
// âœ… tenant_org_id auto-filtered
// âœ… IntelliSense for all fields
// âœ… Compile-time error checking
```

### Connection Strategy

**Prisma:**
- Direct PostgreSQL connection via PgBouncer (connection pooling)
- Transaction mode for serverless compatibility
- Environment: `DATABASE_URL`

**Supabase Client:**
- PostgREST API via HTTPS
- Row Level Security (RLS) enforced
- Environment: `NEXT_PUBLIC_SUPABASE_URL` + `NEXT_PUBLIC_SUPABASE_ANON_KEY`


---

## ğŸ— SYSTEM ARCHITECTURE

### Multi-Tenant Strategy

**Dual-Layer Architecture** for optimal tenant isolation:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SYSTEM LAYER (sys_*)                â”‚
â”‚            Global Shared Data - No Tenant ID          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ sys_customers_mst      - Global customer identitiesâ”‚
â”‚  â€¢ sys_service_category_cd - Service categories       â”‚
â”‚  â€¢ sys_order_type_cd      - Order types              â”‚
â”‚  â€¢ sys_order_status_cd    - Order statuses           â”‚
â”‚  â€¢ sys_payment_method_cd  - Payment methods          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ORGANIZATION LAYER (org_*)               â”‚
â”‚         Tenant-Specific Data with RLS Enforcement     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ org_tenants_mst        - Tenant organizations     â”‚
â”‚  â€¢ org_customers_mst      - Tenant-customer junction â”‚
â”‚  â€¢ org_orders_mst         - Orders (CORE)           â”‚
â”‚  â€¢ org_order_items_dtl    - Order items             â”‚
â”‚  â€¢ org_product_data_mst   - Service catalog         â”‚
â”‚  â€¢ org_branches_mst       - Multiple branches       â”‚
â”‚  â€¢ org_invoice_mst        - Invoices                â”‚
â”‚  â€¢ org_payments_dtl_tr    - Payment transactions    â”‚
â”‚  â€¢ org_subscriptions_mst     - Subscription management â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Critical Pattern
- Many tables use **composite foreign keys** like `(tenant_org_id, customer_id)`
- This enforces tenant isolation at the **database level**
- Row-Level Security (RLS) provides additional runtime enforcement

---

## Technology Stack

### Database Layer
- **Database**: Supabase PostgreSQL
  - Row-Level Security (RLS) enforced per tenant via `tenant_org_id`
  - JSONB columns for flexible metadata
  - Composite primary keys for tenant data isolation
  - Custom domains for data types (MONEY, IS_ACTIVE, etc.)
  - Partitioning for high-volume tables (planned)

### Frontend - Web Admin
- **Framework**: Next.js 15 (App Router)
- **Location**: `web-admin/`
- **Language**: TypeScript 5+
- **UI Framework**: React 19
- **Styling**: Tailwind CSS v4
- **State Management**: React Query + Zustand (minimal)
- **Auth**: Supabase Auth
- **i18n**: next-intl (English + Arabic with RTL)
- **Port**: 3000

### Frontend - Mobile Apps (Planned)
- **Framework**: Flutter 3.16+
- **Directories**:
  - `customer-app/` - Customer ordering app
  - `driver-app/` - Driver delivery app
  - `store-app/` - Store/branch staff app
- **State Management**: Riverpod
- **HTTP Client**: Dio
- **Local Storage**: Hive

### Backend API 
- **Framework**: NestJS (REST + GraphQL)
- **Location**: `cmx-api/`
- **Cache**: Redis 7+
- **Queue**: BullMQ for background jobs
- **Purpose**: Complex business logic, integrations

### Infrastructure

**Supabase Local** (Primary infrastructure):
- **API**: `http://127.0.0.1:54321`
- **Studio**: `http://127.0.0.1:54323`
- **Database**: `postgresql://postgres:postgres@localhost:54322/postgres`
- **Mailpit**: `http://127.0.0.1:54324`

**Docker Compose** (Supporting services only):
- **Redis**: `localhost:6379`
- **MinIO API**: `localhost:9000`
- **MinIO Console**: `localhost:9001`
- **Redis Commander**: `localhost:8081`

**Note:** PostgreSQL runs inside Supabase Local (port 54322), NOT as a separate Docker container.

---

## Architecture Decisions

### Phase 1: Supabase-Only (Current)
- Use Supabase for all CRUD operations
- Leverage auto-generated APIs
- Implement business logic in database functions
- Cost: $0 (free tier)

### Phase 2: Hybrid Architecture (Future)
- Add NestJS for complex business logic
- Keep Supabase for simple CRUD
- Implement background jobs with BullMQ
- Cost: $50-100/month

### Why This Approach?
- Fastest time to market
- Lower initial cost
- Validate business idea quickly
- Scale when revenue justifies it
- Best for solo developer

---

## Return to [Main Documentation](../CLAUDE.md)
